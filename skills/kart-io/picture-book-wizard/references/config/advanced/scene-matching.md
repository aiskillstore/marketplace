# Scene Matching System / 场景匹配系统

**版本**: 1.0
**目的**: 支持用户请求的自定义场景，同时保持核心场景配置精简和现实验证系统的完整性

---

## I. 系统概述 / System Overview

### 核心理念

**保持核心场景精简**：
- 12 个核心场景 = 完整的可观察元素数据库（HIGH validation）
- 扩展场景 = 智能匹配 + 动态推理（MEDIUM validation）
- 避免无限膨胀配置文件

**三层验证策略**：
1. **通用规则**（所有场景）：物理、生物、观察能力、常识
2. **类别规则**（场景类别）：该类别共同的验证规则
3. **特定规则**（核心12场景）：详细的可观察元素列表

---

## II. 场景分类系统 / Scene Category System

### Category 1: 开阔地形类 (Open Terrain)

**核心场景**：`meadow` (草地)

**可匹配场景**：
- **高原** (plateau) - 匹配度 75%
- **草原** (grassland) - 匹配度 90%
- **平原** (plain) - 匹配度 85%
- **牧场** (pasture) - 匹配度 80%
- **田野** (field) - 匹配度 85%

**共同特征**：
- ✅ 开阔视野
- ✅ 地面观察视角
- ✅ 草本植被为主
- ✅ 自然光线充足
- ✅ 天空可见

**通用验证规则**：
```markdown
✅ 可观察元素（所有开阔地形）：
- 草地/植被表面
- 天空和云
- 地平线/远景
- 地面小动物（昆虫、鸟类）
- 风吹动植物
- 阳光和阴影

❌ 不可观察（所有开阔地形）：
- 地下根系（除非挖掘）
- 土壤内部结构
- 微生物
- 地下水位
```

**场景特定调整**：

**高原 (Plateau)**：
- **添加元素**：
  - 远处雪山/山峦
  - 稀疏矮小植被
  - 高原特有动物（牦牛、旱獭）
  - 强烈日光效果
- **调整规则**：
  - 植被密度：低于标准草地
  - 物种多样性：减少
  - 海拔效应：提及但不夸大（儿童友好）
- **避免错误**：
  - ❌ "茂密热带植物"（高海拔不适合）
  - ❌ "蝴蝶和蜜蜂很多"（高原昆虫稀少）
  - ❌ "空气稀薄导致呼吸困难"（儿童内容不适合负面体验）

**草原 (Grassland)**：
- **添加元素**：
  - 广阔无边的视野
  - 野生动物（鹿、兔）
  - 草浪随风起伏
- **调整规则**：
  - 强调广阔感
  - 野生属性更强

**牧场 (Pasture)**：
- **添加元素**：
  - 围栏
  - 家畜（牛、羊、马）
  - 农场建筑（远处）
- **调整规则**：
  - 人工管理痕迹
  - 家畜与野生动物的区别

---

### Category 2: 密集植被类 (Dense Vegetation)

**核心场景**：`forest` (森林)

**可匹配场景**：
- **竹林** (bamboo forest) - 匹配度 70%
- **树林** (woods) - 匹配度 95%
- **丛林** (jungle) - 匹配度 60%
- **山坡树林** (hillside forest) - 匹配度 85%
- **果园** (orchard) - 匹配度 65%

**共同特征**：
- ✅ 植被密集
- ✅ 有遮蔽/树冠
- ✅ 光影斑驳
- ✅ 垂直空间结构
- ✅ 地面到树冠的分层

**通用验证规则**：
```markdown
✅ 可观察元素（所有密集植被）：
- 树干/茎干表面
- 树皮纹理（或茎秆）
- 叶子形状和颜色
- 树冠/植被顶部
- 地面落叶/碎屑
- 藤蔓、苔藓、地衣
- 林间光线和阴影

❌ 不可观察（所有密集植被）：
- 年轮（活树上）
- 内部木纹
- 地下根系
- 树内管道系统
```

**场景特定调整**：

**竹林 (Bamboo Forest)**：
- **关键差异**：
  - 竹子 ≠ 树木（是草本植物）
  - 竹节、竹叶完全不同
  - 生长速度快
- **添加元素**：
  - 竹节（节状结构）
  - 竹叶（细长、成簇）
  - 竹笋（地面）
  - 特有声音（风吹竹叶沙沙声）
- **调整规则**：
  - 不能使用"树木"术语，应该是"竹子"
  - 竹子是空心的（但不能说"看到内部"）
  - 竹笋可见（春季）
- **避免错误**：
  - ❌ "竹子的年轮"（草本植物没有年轮）
  - ❌ "粗糙的树皮"（竹子表面光滑）
  - ❌ "树枝上的鸟巢"（竹子很少有大型鸟巢）

**丛林 (Jungle)**：
- **添加元素**：
  - 极度茂密的植被
  - 热带植物（大叶子、藤蔓）
  - 高温高湿（可见效果：水汽）
  - 热带动物
- **调整规则**：
  - 植被密度极高
  - 多层次结构（地面、灌木、树冠、藤蔓）
- **避免错误**：
  - ❌ "在温带气候的丛林"（地理矛盾）
  - ❌ "清晰的地平线"（丛林遮蔽视野）

**果园 (Orchard)**：
- **添加元素**：
  - 果树（苹果、梨、桃等）
  - 果实（当季）
  - 整齐排列
  - 人工管理痕迹
- **调整规则**：
  - 果树种类一致性
  - 季节与果实匹配
- **避免错误**：
  - ❌ "冬天树上挂满苹果"（季节矛盾）

---

### Category 3: 水域类 (Water Bodies)

**核心场景**：`pond` (水潭)

**可匹配场景**：
- **湖泊** (lake) - 匹配度 85%
- **小溪** (stream) - 匹配度 70%
- **河边** (riverside) - 匹配度 75%
- **瀑布** (waterfall) - 匹配度 60%
- **喷泉** (fountain) - 匹配度 50%

**共同特征**：
- ✅ 水面可见
- ✅ 水的特性（流动/静止、透明/浑浊）
- ✅ 水边环境
- ✅ 可能有倒影
- ✅ 水生植物或动物

**通用验证规则**：
```markdown
✅ 可观察元素（所有水域）：
- 水面（静止或流动）
- 水的颜色和透明度
- 水面倒影（静止水面）
- 水边植被
- 浅水区底部（如果清澈）
- 水生动物（鱼、青蛙等，如可见）
- 波纹、水花
- 水声（流动水）

❌ 不可观察（所有水域）：
- 深水区底部（光线无法穿透）
- 水下根系（深处）
- 水分子结构
- 溶解物质（除非改变水色）
- 地下水源
```

**场景特定调整**：

**湖泊 (Lake)**：
- **添加元素**：
  - 更大规模
  - 远处对岸（或看不到）
  - 可能有船只
  - 湖中心水深（不透明）
- **调整规则**：
  - 视野更广
  - 深度感

**小溪 (Stream)**：
- **添加元素**：
  - 流动的水
  - 溪流声
  - 小石头、鹅卵石
  - 水流冲刷痕迹
- **调整规则**：
  - 强调流动性
  - 浅水可见底部
- **避免错误**：
  - ❌ "静止的湖面倒影"（溪水流动，倒影扭曲）

**瀑布 (Waterfall)**：
- **添加元素**：
  - 下落的水流
  - 水雾
  - 瀑布声（轰鸣）
  - 彩虹（阳光+水雾）
- **调整规则**：
  - 水的运动感
  - 声音和视觉结合
- **避免错误**：
  - ❌ "清晰的水面倒影"（瀑布水流湍急）

---

### Category 4: 天空类 (Sky & Celestial)

**核心场景**：`stars` (星空)

**可匹配场景**：
- **夜空** (night sky) - 匹配度 95%
- **日出** (sunrise) - 匹配度 60%
- **日落** (sunset) - 匹配度 60%
- **云层** (clouds) - 匹配度 50%
- **极光** (aurora) - 匹配度 40%

**共同特征**：
- ✅ 仰视视角
- ✅ 天空现象
- ✅ 光线效果
- ✅ 广阔感、距离感
- ✅ 时间特征明显

**通用验证规则**：
```markdown
✅ 可观察元素（天空类）：
- 星星（点状光源）
- 月亮（相位变化）
- 太阳（不直视）
- 云朵（形状、颜色）
- 天空颜色渐变
- 地平线剪影
- 大气光学现象（彩虹、霞光）

❌ 不可观察（天空类）：
- 星球表面细节（太远）
- 星座实际距离（三维）
- 大气层结构
- 宇宙空间物体细节
```

**场景特定调整**：

**日出/日落 (Sunrise/Sunset)**：
- **添加元素**：
  - 地平线
  - 天空颜色渐变（橙、粉、紫）
  - 太阳（不直视）
  - 逆光剪影
- **调整规则**：
  - 时间感（清晨/傍晚）
  - 光线方向
- **避免错误**：
  - ❌ "直视太阳看到表面"（危险且不可能）
  - ❌ "午夜日出"（时间矛盾）

**极光 (Aurora)**：
- **添加元素**：
  - 绿色/粉色光带
  - 夜空背景
  - 极地环境（寒冷）
- **限制**：
  - 仅在高纬度地区
  - 需要特定地理背景
- **避免错误**：
  - ❌ "在热带看到极光"（地理不可能）

---

### Category 5: 建筑类 (Architecture)

**核心场景**：`courtyard` (四合院), `temple` (寺庙)

**可匹配场景**：
- **园林** (garden) - 匹配度 80% → courtyard
- **亭台** (pavilion) - 匹配度 75% → courtyard
- **古建筑** (ancient architecture) - 匹配度 70% → temple
- **城墙** (city wall) - 匹配度 60% → courtyard
- **桥** (bridge) - 匹配度 50% → courtyard

**共同特征**：
- ✅ 人工结构
- ✅ 建筑材料（木、石、砖）
- ✅ 中国传统元素
- ✅ 文化和历史感

**通用验证规则**：
```markdown
✅ 可观察元素（建筑类）：
- 外部结构（柱、梁、墙、瓦）
- 装饰元素（雕刻、彩绘）
- 材料纹理
- 建筑轮廓
- 周围环境

❌ 不可观察（建筑类）：
- 墙内部结构
- 地基深度
- 隐藏的连接件
- 管道系统
```

---

### Category 6: 室内类 (Indoor)

**核心场景**：`kitchen` (厨房), `grandma-room` (奶奶房间), `kindergarten` (幼儿园)

**可匹配场景**：
- **客厅** (living room) - 匹配度 75% → grandma-room
- **卧室** (bedroom) - 匹配度 80% → grandma-room
- **书房** (study) - 匹配度 70% → grandma-room
- **教室** (classroom) - 匹配度 90% → kindergarten
- **图书馆** (library) - 匹配度 60% → grandma-room

**共同特征**：
- ✅ 封闭空间
- ✅ 人工照明或窗户光
- ✅ 家具和物品
- ✅ 室内温度（舒适）
- ✅ 人类活动痕迹

**通用验证规则**：
```markdown
✅ 可观察元素（室内类）：
- 家具外观
- 物品摆放
- 装饰品
- 窗户和光线
- 墙面、地面
- 室内植物

❌ 不可观察（室内类）：
- 家具内部结构
- 墙体内部
- 电线布局
- 管道系统
```

---

### Category 7: 特殊环境 (Special Environments)

**这些场景需要特别注意，可能不适合直接匹配**

**沙漠 (Desert)**：
- **匹配度**: 低（与所有核心场景差异大）
- **推荐**: 创建专用验证规则或警告用户
- **关键差异**：
  - 极度干燥
  - 沙子（不是土壤）
  - 极端温差
  - 稀少生物
- **如果使用**：基于 `meadow` 但大量调整

**海滩 (Beach)**：
- **匹配度**: 低
- **推荐**: 创建专用规则
- **关键差异**：
  - 沙 + 海水组合
  - 潮汐
  - 海洋生物
  - 盐分

**雪地 (Snow Field)**：
- **匹配度**: 中等 → `meadow`（开阔地形）
- **关键调整**：
  - 冬季环境
  - 雪覆盖
  - 寒冷生物适应

**洞穴 (Cave)**：
- **匹配度**: 极低
- **推荐**: 警告用户
- **关键问题**：
  - 黑暗（需要光源）
  - 封闭空间
  - 特殊地质结构
  - 可能不适合幼儿内容（恐惧感）

**极端环境（不推荐）**：
- ❌ **海底** (Underwater) - 完全不同的物理规则
- ❌ **太空** (Space) - 无重力、无空气
- ❌ **火山** (Volcano) - 危险、极端高温
- ❌ **地下** (Underground) - 黑暗、恐惧

---

## III. 匹配流程 / Matching Process

### Step 1: 场景识别

```
INPUT: 用户场景名称（中文或英文）

PROCESS:
1. 标准化场景名称
2. 检查是否在核心12场景中
3. 如果不在 → 进入匹配流程
```

### Step 2: 场景分类

```
ANALYZE:
- 场景描述中的关键词
- 环境特征（开阔/封闭、自然/人工、室内/室外）
- 植被类型
- 水的存在
- 建筑元素

CLASSIFY:
→ Category 1: 开阔地形
→ Category 2: 密集植被
→ Category 3: 水域
→ Category 4: 天空
→ Category 5: 建筑
→ Category 6: 室内
→ Category 7: 特殊环境（警告）
```

### Step 3: 相似度计算

```
FOR EACH core_scene IN category:
    similarity = calculate_similarity(
        user_scene,
        core_scene,
        features=[
            'terrain_type',      # 地形类型 30%
            'vegetation_density', # 植被密度 20%
            'water_presence',    # 水体存在 15%
            'openness',          # 开阔度 15%
            'lighting',          # 光线条件 10%
            'human_elements'     # 人工元素 10%
        ]
    )

SELECT: highest_similarity_scene
```

### Step 4: 生成调整建议

```
GENERATE:
- 需要添加的特定元素
- 需要调整的验证规则
- 需要避免的常见错误
- 验证等级（HIGH/MEDIUM/LOW）
```

### Step 5: 用户确认

```
PRESENT:
┌─────────────────────────────────────────────────┐
│ 💡 场景匹配建议                                 │
├─────────────────────────────────────────────────┤
│ 请求场景：高原 (Plateau)                        │
│ 场景类别：开阔地形类                            │
│                                                 │
│ 🎯 最佳匹配：草地 (Meadow) - 相似度 75%         │
│                                                 │
│ 📊 共同特征：                                   │
│ ✅ 开阔视野                                     │
│ ✅ 草本植被                                     │
│ ✅ 地面观察视角                                 │
│ ✅ 自然光线充足                                 │
│                                                 │
│ 🔧 需要调整的元素：                             │
│ • 植被：稀疏矮小（高海拔特征）                  │
│ • 远景：添加雪山/远山                           │
│ • 动物：高原特有（牦牛、旱獭）                  │
│ • 光线：强烈日光效果                            │
│                                                 │
│ ⚠️ 需要避免的错误：                             │
│ ❌ "茂密热带植物"（高海拔不适合）               │
│ ❌ "大量蝴蝶和蜜蜂"（高原昆虫稀少）             │
│                                                 │
│ 📋 验证等级：MEDIUM                             │
│ （使用通用规则 + 类别规则 + 场景推理）          │
│                                                 │
│ 选项：                                          │
│ [✓ 使用此匹配生成] [查看其他匹配] [自定义]      │
└─────────────────────────────────────────────────┘
```

---

## IV. 测试案例 / Test Cases

### 测试案例 1：高原 (Plateau)

**输入**：
```
/picture-book-wizard watercolor 高原 8 theme:discovery
```

**预期处理**：
```
1. 识别："高原"不在核心12场景
2. 分类：开阔地形类
3. 匹配：meadow (75%)
4. 验证等级：MEDIUM
5. 调整建议：
   - 添加：远山、稀疏植被、高原动物
   - 避免：茂密植被、低海拔物种
6. 用户确认
7. 生成内容（使用调整后的规则）
```

**预期输出特征**：
```
故事：悦悦在高原上发现了一株矮小的高山花...
提示词：...sparse highland vegetation, distant snow-capped mountains,
         strong sunlight, thin air atmosphere, yak in distance...
学习要点：科学（高原植物适应高海拔环境）
验证报告：✅ MEDIUM validation passed
```

---

### 测试案例 2：竹林 (Bamboo Forest)

**输入**：
```
/picture-book-wizard ink 竹林 7 emotion:calm
```

**预期处理**：
```
1. 识别："竹林"不在核心场景
2. 分类：密集植被类
3. 匹配：forest (70%)
4. 验证等级：MEDIUM
5. 关键差异警告：
   ⚠️ 竹子 ≠ 树木（草本植物 vs. 木本植物）
   ⚠️ 不能使用"树"相关术语
6. 调整建议：
   - 特有元素：竹节、竹叶、竹笋
   - 术语替换："竹子"而非"树"
   - 避免：年轮、树皮、树枝
7. 用户确认
```

**预期输出特征**：
```
故事：悦悦走在竹林中，听到风吹竹叶的沙沙声...
提示词：...bamboo forest, bamboo stalks with visible nodes,
         narrow bamboo leaves rustling, bamboo shoots on ground...
学习要点：竹 (zhú) - bamboo
科学：竹子是草本植物，生长快，有节状结构
验证报告：✅ MEDIUM validation, 特别注意：避免树木术语
```

---

### 测试案例 3：小溪 (Stream)

**输入**：
```
/picture-book-wizard watercolor 小溪 6 theme:nature
```

**预期处理**：
```
1. 识别："小溪"不在核心场景
2. 分类：水域类
3. 匹配：pond (70%)
4. 验证等级：MEDIUM
5. 关键差异：
   - 小溪：流动水
   - 水潭：静止水
6. 调整建议：
   - 添加：流动效果、溪流声、鹅卵石
   - 移除：静止倒影（改为扭曲倒影）
7. 用户确认
```

**预期输出特征**：
```
故事：悦悦在小溪边发现清澈的溪水缓缓流淌...
提示词：...flowing stream, clear water over pebbles,
         gentle water movement, distorted reflections in ripples...
学习要点：水 (shuǐ) - water
科学：流动的水不能形成清晰倒影
验证报告：✅ MEDIUM validation, 已调整：流动 vs. 静止水特性
```

---

### 测试案例 4：沙漠 (Desert) - 低匹配度警告

**输入**：
```
/picture-book-wizard clay 沙漠 9 theme:exploration
```

**预期处理**：
```
1. 识别："沙漠"不在核心场景
2. 分类：特殊环境
3. 匹配：meadow (35%) - 相似度低
4. 警告：
   ⚠️ 沙漠环境与所有核心场景差异较大
   ⚠️ 可观察元素完全不同
   ⚠️ 验证等级：LOW
5. 建议选项：
   [a] 使用 meadow 作为基础（大量调整）
   [b] 使用自定义场景（低验证）
   [c] 改用核心场景（高验证）
```

**用户确认后**：
```
如果选择 [b] 自定义场景：

⚠️ 自定义场景警告：
- 验证等级：LOW（仅通用物理和生物规则）
- 无详细可观察元素数据库
- 需要您自行判断科学准确性
- 建议：请在使用前向领域专家确认内容

是否继续？ [确认] [取消]
```

---

### 测试案例 5：海底 (Underwater) - 不推荐场景

**输入**：
```
/picture-book-wizard tech 海底 8
```

**预期处理**：
```
1. 识别："海底"不在核心场景
2. 分类：极端环境
3. 匹配：无合适匹配
4. 警告：
   ⚠️ 极端环境警告

   海底环境不适合儿童绘本的原因：
   - 物理规则完全不同（水压、浮力、光线）
   - 儿童无法亲身体验（安全隔绝）
   - 观察限制极大（设备依赖）
   - 可能引起恐惧（黑暗、未知）

   建议替代：
   • pond (水潭) - 浅水观察，安全友好
   • 水族馆场景（自定义）- 室内安全环境

   如果仍要生成海底场景：
   - 验证等级：VERY LOW
   - 仅适用于想象/幻想主题
   - 不作为科学教育内容

是否继续？ [取消] [了解风险后继续]
```

---

### 测试案例 6：教室 (Classroom)

**输入**：
```
/picture-book-wizard storybook 教室 5 theme:friendship
```

**预期处理**：
```
1. 识别："教室"不在核心场景
2. 分类：室内类
3. 匹配：kindergarten (90%) - 高度相似
4. 验证等级：MEDIUM-HIGH
5. 调整建议：
   - 年龄调整：幼儿园 → 小学教室
   - 家具尺寸：更大的桌椅
   - 教学内容：更复杂的海报和教材
6. 用户确认
```

**预期输出**：
```
故事：悦悦在教室里和同学分享她的图画书...
提示词：...elementary school classroom, rows of desks,
         educational posters on walls, children aged 5-6...
验证报告：✅ MEDIUM-HIGH validation（与核心场景极相似）
```

---

## V. 验证等级定义 / Validation Levels

### HIGH Validation（核心12场景）

**特征**：
- ✅ 完整的可观察元素数据库
- ✅ 详细的常见错误列表
- ✅ 场景特定的40+红旗模式
- ✅ 年龄分组的观察能力
- ✅ 所有四层验证规则

**适用**：
- meadow, pond, rice-paddy, stars, forest
- kitchen, courtyard, market, temple, festival, grandma-room, kindergarten

**质量保证**：错误预防率 >90%

---

### MEDIUM Validation（匹配场景）

**特征**：
- ✅ 通用物理和生物规则（层级1）
- ✅ 场景类别规则（层级2）
- ✅ AI推理的可观察元素
- ⚠️ 场景特定规则由AI生成
- ⚠️ 用户需要确认调整建议

**适用**：
- 相似度 >60% 的匹配场景
- 例如：高原→meadow, 竹林→forest, 小溪→pond

**质量保证**：错误预防率 ~70%，依赖AI推理准确性

---

### LOW Validation（自定义场景）

**特征**：
- ✅ 通用物理和生物规则（层级1）
- ❌ 无场景类别规则
- ❌ 无详细可观察元素数据库
- ⚠️ 用户自行负责科学准确性

**适用**：
- 相似度 <60% 的场景
- 例如：沙漠、海滩（与核心场景差异大）

**质量保证**：错误预防率 ~40%，主要依赖用户判断

**警告提示**：
```
⚠️ LOW VALIDATION WARNING

此场景使用低等级验证，仅检查基本物理和生物规则。
建议在发布前请领域专家审核科学准确性。

[我理解风险] [返回选择核心场景]
```

---

### VERY LOW / NOT RECOMMENDED（极端环境）

**特征**：
- ⚠️ 仅基础规则
- ⚠️ 可能不适合儿童内容
- ⚠️ 强烈建议改用其他场景

**适用**：
- 海底、太空、火山内部、洞穴（黑暗）
- 危险或恐惧场景

**警告提示**：
```
🚫 NOT RECOMMENDED FOR CHILDREN'S CONTENT

此场景可能不适合儿童绘本：
- 物理环境极端或危险
- 儿童无法亲身体验
- 可能引起恐惧或焦虑

强烈建议使用核心场景或适合儿童的替代场景。

[了解风险后继续] [取消]
```

---

## VI. 实现优先级 / Implementation Priority

### Phase 1: 核心功能（立即实现）
- ✅ 场景分类系统（7大类别）
- ✅ 相似度匹配算法
- ✅ 验证等级定义
- ✅ 用户确认流程
- ✅ 6个测试案例

### Phase 2: 优化体验（后续）
- 多语言场景名称识别
- 自动学习用户偏好
- 匹配建议优化

### Phase 3: 高级功能（长期）
- 常用自定义场景记录
- 社区贡献场景库
- 动态验证规则生成

---

## VII. 总结 / Summary

**核心优势**：
✅ 保持12个核心场景配置精简
✅ 支持无限扩展场景需求
✅ 维持现实验证系统完整性
✅ 分层验证策略（HIGH/MEDIUM/LOW）
✅ 透明的质量保证等级
✅ 用户知情选择权

**质量保证**：
- 核心场景：>90% 错误预防
- 匹配场景：~70% 错误预防（AI推理）
- 自定义场景：~40% 错误预防（用户自负责）
- 极端环境：建议不使用

**用户体验**：
- 清晰的匹配建议
- 透明的调整说明
- 明确的验证等级
- 风险警告（低匹配度场景）

---

**文件版本**: 1.0
**创建日期**: 2026-01-10
**状态**: 准备测试和验证
