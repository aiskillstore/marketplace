{
  "schema_version": "2.0",
  "meta": {
    "generated_at": "2026-01-16T18:48:01.426Z",
    "slug": "benderfendor-backend-hang-debug",
    "source_url": "https://github.com/BenderFendor/Thesis/tree/main/.github/skills/backend-hang-debug",
    "source_ref": "main",
    "model": "claude",
    "analysis_version": "3.0.0",
    "source_type": "community",
    "content_hash": "ccb5605e44410e1a62eaa7848a1c9a9e71f97eb5f947b63e16b974a84e6ced6c",
    "tree_hash": "bc6a6c6a4f65ab3b43a21b5d686765449a889c4d42f308d2b1570a6f92f69811"
  },
  "skill": {
    "name": "backend-hang-debug",
    "description": "Diagnose and fix FastAPI hangs caused by blocking ThreadPoolExecutor shutdown in the news stream route; includes py-spy capture and non-blocking executor pattern.",
    "summary": "Diagnose and fix FastAPI hangs caused by blocking ThreadPoolExecutor shutdown in the news stream rou...",
    "icon": "üêõ",
    "version": "1.0.0",
    "author": "BenderFendor",
    "license": "MIT",
    "category": "devops",
    "tags": [
      "fastapi",
      "debugging",
      "threadpool",
      "performance",
      "py-spy"
    ],
    "supported_tools": [
      "claude",
      "codex",
      "claude-code"
    ],
    "risk_factors": [
      "external_commands",
      "network",
      "filesystem"
    ]
  },
  "security_audit": {
    "risk_level": "safe",
    "is_blocked": false,
    "safe_to_publish": true,
    "summary": "This is a documentation-only skill containing markdown instructions for debugging FastAPI hangs. The static analyzer flagged 74 pattern matches, but all are false positives: the skill contains no executable code, scripts, network operations, or filesystem access beyond reading its own file. The 'commands' flagged are documentation examples showing diagnostic commands users might run on their own systems. Pure informational content safe for publication.",
    "risk_factor_evidence": [
      {
        "factor": "external_commands",
        "evidence": [
          {
            "file": "skill-report.json",
            "line_start": 126,
            "line_end": 126
          },
          {
            "file": "skill-report.json",
            "line_start": 77,
            "line_end": 77
          },
          {
            "file": "skill-report.json",
            "line_start": 126,
            "line_end": 126
          },
          {
            "file": "SKILL.md",
            "line_start": 9,
            "line_end": 9
          },
          {
            "file": "SKILL.md",
            "line_start": 10,
            "line_end": 10
          },
          {
            "file": "SKILL.md",
            "line_start": 13,
            "line_end": 13
          },
          {
            "file": "SKILL.md",
            "line_start": 13,
            "line_end": 13
          },
          {
            "file": "SKILL.md",
            "line_start": 14,
            "line_end": 14
          },
          {
            "file": "SKILL.md",
            "line_start": 14,
            "line_end": 14
          },
          {
            "file": "SKILL.md",
            "line_start": 17,
            "line_end": 17
          },
          {
            "file": "SKILL.md",
            "line_start": 17,
            "line_end": 17
          },
          {
            "file": "SKILL.md",
            "line_start": 18,
            "line_end": 18
          },
          {
            "file": "SKILL.md",
            "line_start": 18,
            "line_end": 18
          },
          {
            "file": "SKILL.md",
            "line_start": 19,
            "line_end": 19
          },
          {
            "file": "SKILL.md",
            "line_start": 19,
            "line_end": 19
          },
          {
            "file": "SKILL.md",
            "line_start": 19,
            "line_end": 19
          },
          {
            "file": "SKILL.md",
            "line_start": 19,
            "line_end": 19
          },
          {
            "file": "SKILL.md",
            "line_start": 22,
            "line_end": 22
          },
          {
            "file": "SKILL.md",
            "line_start": 22,
            "line_end": 22
          },
          {
            "file": "SKILL.md",
            "line_start": 25,
            "line_end": 25
          },
          {
            "file": "SKILL.md",
            "line_start": 25,
            "line_end": 25
          },
          {
            "file": "SKILL.md",
            "line_start": 26,
            "line_end": 26
          },
          {
            "file": "SKILL.md",
            "line_start": 29,
            "line_end": 29
          },
          {
            "file": "SKILL.md",
            "line_start": 30,
            "line_end": 30
          },
          {
            "file": "SKILL.md",
            "line_start": 31,
            "line_end": 31
          },
          {
            "file": "SKILL.md",
            "line_start": 32,
            "line_end": 32
          },
          {
            "file": "SKILL.md",
            "line_start": 33,
            "line_end": 33
          },
          {
            "file": "SKILL.md",
            "line_start": 33,
            "line_end": 33
          },
          {
            "file": "SKILL.md",
            "line_start": 34,
            "line_end": 34
          },
          {
            "file": "SKILL.md",
            "line_start": 34,
            "line_end": 34
          },
          {
            "file": "SKILL.md",
            "line_start": 36,
            "line_end": 36
          },
          {
            "file": "SKILL.md",
            "line_start": 38,
            "line_end": 38
          },
          {
            "file": "SKILL.md",
            "line_start": 38,
            "line_end": 38
          },
          {
            "file": "SKILL.md",
            "line_start": 41,
            "line_end": 41
          },
          {
            "file": "SKILL.md",
            "line_start": 42,
            "line_end": 42
          },
          {
            "file": "SKILL.md",
            "line_start": 43,
            "line_end": 43
          },
          {
            "file": "SKILL.md",
            "line_start": 44,
            "line_end": 44
          },
          {
            "file": "SKILL.md",
            "line_start": 44,
            "line_end": 44
          },
          {
            "file": "SKILL.md",
            "line_start": 50,
            "line_end": 50
          },
          {
            "file": "SKILL.md",
            "line_start": 18,
            "line_end": 18
          },
          {
            "file": "SKILL.md",
            "line_start": 19,
            "line_end": 19
          },
          {
            "file": "SKILL.md",
            "line_start": 18,
            "line_end": 18
          },
          {
            "file": "SKILL.md",
            "line_start": 19,
            "line_end": 19
          },
          {
            "file": "SKILL.md",
            "line_start": 19,
            "line_end": 19
          }
        ]
      },
      {
        "factor": "network",
        "evidence": [
          {
            "file": "skill-report.json",
            "line_start": 103,
            "line_end": 103
          },
          {
            "file": "skill-report.json",
            "line_start": 6,
            "line_end": 6
          },
          {
            "file": "skill-report.json",
            "line_start": 129,
            "line_end": 129
          },
          {
            "file": "SKILL.md",
            "line_start": 34,
            "line_end": 34
          },
          {
            "file": "SKILL.md",
            "line_start": 43,
            "line_end": 43
          },
          {
            "file": "SKILL.md",
            "line_start": 9,
            "line_end": 9
          },
          {
            "file": "SKILL.md",
            "line_start": 17,
            "line_end": 17
          },
          {
            "file": "SKILL.md",
            "line_start": 17,
            "line_end": 17
          },
          {
            "file": "SKILL.md",
            "line_start": 36,
            "line_end": 36
          },
          {
            "file": "SKILL.md",
            "line_start": 41,
            "line_end": 41
          },
          {
            "file": "SKILL.md",
            "line_start": 42,
            "line_end": 42
          }
        ]
      },
      {
        "factor": "filesystem",
        "evidence": [
          {
            "file": "skill-report.json",
            "line_start": 6,
            "line_end": 6
          },
          {
            "file": "SKILL.md",
            "line_start": 19,
            "line_end": 19
          },
          {
            "file": "SKILL.md",
            "line_start": 18,
            "line_end": 18
          }
        ]
      }
    ],
    "critical_findings": [],
    "high_findings": [],
    "medium_findings": [],
    "low_findings": [],
    "dangerous_patterns": [],
    "files_scanned": 2,
    "total_lines": 229,
    "audit_model": "claude",
    "audited_at": "2026-01-16T18:48:01.426Z"
  },
  "content": {
    "user_title": "Diagnose and fix FastAPI hangs",
    "value_statement": "FastAPI applications can hang when ThreadPoolExecutor shutdown blocks the event loop, especially during SSE stream disconnects. This skill provides a repeatable triage workflow using py-spy to capture live stacks and apply non-blocking executor patterns to restore responsiveness.",
    "seo_keywords": [
      "FastAPI hang debugging",
      "ThreadPoolExecutor shutdown",
      "py-spy stack capture",
      "event loop blocking",
      "SSE stream issues",
      "FastAPI performance",
      "Claude Code debugging",
      "Python concurrency debugging",
      "backend troubleshooting",
      "FastAPI devops"
    ],
    "actual_capabilities": [
      "Detect event-loop hangs in FastAPI applications",
      "Use py-spy to capture live stack dumps from running processes",
      "Identify blocking ThreadPoolExecutor.shutdown calls in stream routes",
      "Apply non-blocking executor pattern to prevent event loop blocking",
      "Verify fixes with curl smoke tests and process checks",
      "Debug multi-worker uvicorn deployments"
    ],
    "limitations": [
      "Requires pre-installed py-spy with sudo permissions for stack capture",
      "Cannot auto-fix code; provides patterns users must implement manually",
      "Does not cover database connection pool issues or async I/O blocking",
      "Assumes Linux environment with ss, procfs, and standard Linux tools"
    ],
    "use_cases": [
      {
        "target_user": "Backend Developers",
        "title": "Debug production hangs",
        "description": "Diagnose why FastAPI app stops responding to health checks during active SSE stream connections"
      },
      {
        "target_user": "DevOps Engineers",
        "title": "Triage event loop issues",
        "description": "Use py-spy to capture blocking stack frames and identify ThreadPoolExecutor.shutdown as the root cause"
      },
      {
        "target_user": "Full-Stack Developers",
        "title": "Fix stream disconnects",
        "description": "Implement non-blocking executor pattern so aborting stream requests does not freeze the backend"
      }
    ],
    "prompt_templates": [
      {
        "title": "Quick hang diagnosis",
        "scenario": "FastAPI app unresponsive",
        "prompt": "My FastAPI app stopped responding to requests. How do I use py-spy to find what's blocking the event loop?"
      },
      {
        "title": "Stack trace analysis",
        "scenario": "py-spy output available",
        "prompt": "I captured a py-spy dump and see ThreadPoolExecutor.shutdown in the frames. What does this mean and how do I fix it?"
      },
      {
        "title": "Implement non-blocking executor",
        "scenario": "Stream route identified",
        "prompt": "Help me refactor my stream.py to use a non-blocking ThreadPoolExecutor pattern that does not block on shutdown."
      },
      {
        "title": "Verify fix effectiveness",
        "scenario": "Fix implemented",
        "prompt": "I applied the non-blocking executor pattern. How do I verify with py-spy that the event loop is no longer blocked?"
      }
    ],
    "output_examples": [
      {
        "input": "My FastAPI news stream route is causing the app to hang. Health checks timeout when streams are active.",
        "output": [
          "The hang is likely caused by ThreadPoolExecutor.shutdown(wait=True) blocking the event loop during client disconnects.",
          "1. Capture live stacks with: sudo py-spy dump --pid $(pgrep -f 'uvicorn app.main')",
          "2. Look for ThreadPoolExecutor.shutdown frames in api/routes/stream.py",
          "3. Refactor to use non-blocking executor: Create executor outside context manager, use cancel() on disconnect, and call shutdown(wait=False, cancel_futures=True) in finally block.",
          "4. Verify with: curl -m 5 http://localhost:8000/health during active stream"
        ]
      }
    ],
    "best_practices": [
      "Always use shutdown(wait=False, cancel_futures=True) for executors in async contexts to prevent event loop blocking.",
      "Capture py-spy stacks before restarting the service to preserve evidence of the blocking operation.",
      "Test stream abort scenarios during development to catch hangs early before production deployment."
    ],
    "anti_patterns": [
      "Using 'with ThreadPoolExecutor()' as context manager in async code - it calls shutdown(wait=True) which blocks.",
      "Awaiting executor.shutdown() inside async functions - this synchronously blocks the event loop.",
      "Ignoring client disconnects without cancelling pending futures - they can hold resources and cause resource leaks."
    ],
    "faq": [
      {
        "question": "Which Python versions support the non-blocking executor pattern?",
        "answer": "Python 3.9+ supports shutdown(wait=False, cancel_futures=True). Earlier versions require workarounds like running shutdown in a thread."
      },
      {
        "question": "What are reasonable timeouts for curl smoke tests?",
        "answer": "Use -m 5 for quick health checks (5 second max). Increase to -m 30 for full stream tests to avoid false positives."
      },
      {
        "question": "How do I integrate this with Docker deployments?",
        "answer": "Install py-spy in the Docker image, then use docker exec to run stack captures. Ensure the container has CAP_SYS_PTRACE or run py-spy with appropriate capabilities."
      },
      {
        "question": "Does this skill collect any data from my system?",
        "answer": "No. This skill provides documentation only. It contains no executable code and makes no network calls or file system accesses."
      },
      {
        "question": "Why does my app hang only during stream disconnects?",
        "answer": "The context manager calls shutdown(wait=True), which blocks until all worker threads complete. If threads are stuck on network I/O, the event loop waits indefinitely."
      },
      {
        "question": "How does this compare to using asyncio threads?",
        "answer": "ThreadPoolExecutor with blocking I/O works but requires careful shutdown. asyncio.to_thread is simpler for fire-and-forget tasks but also benefits from non-blocking patterns when task cancellation is needed."
      }
    ]
  },
  "file_structure": [
    {
      "name": "SKILL.md",
      "type": "file",
      "path": "SKILL.md",
      "lines": 51
    }
  ]
}
