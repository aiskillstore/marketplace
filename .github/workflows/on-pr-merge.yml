name: On PR Merge - Approve Plugin

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  approve-plugin:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'pending-review')
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use PAT instead of GITHUB_TOKEN to trigger downstream workflows (sync-to-supabase)
          # GITHUB_TOKEN pushes do NOT trigger other workflows by design
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Clean workspace
        # Self-hosted runners can have stale files from previous runs
        # This ensures git detects all file changes correctly
        run: |
          git clean -fdx
          git reset --hard HEAD

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Find pending plugins to approve
        id: find_pending
        run: |
          PLUGIN_PATHS=""
          
          for entry_file in $(find pending -name "marketplace-entry.json" 2>/dev/null); do
            PLUGIN_DIR=$(dirname "$entry_file")
            PLUGIN_PATHS="$PLUGIN_PATHS $PLUGIN_DIR"
          done
          
          echo "plugin_paths=$PLUGIN_PATHS" >> $GITHUB_OUTPUT
          echo "Found pending plugins:$PLUGIN_PATHS"

      - name: Move plugins from pending to plugins
        run: |
          for PENDING_DIR in ${{ steps.find_pending.outputs.plugin_paths }}; do
            if [ -d "$PENDING_DIR" ] && [ -f "$PENDING_DIR/marketplace-entry.json" ]; then
              NAMESPACED_SLUG=$(jq -r '.slug' "$PENDING_DIR/marketplace-entry.json")
              TARGET_DIR="plugins/$NAMESPACED_SLUG"
              
              echo "Moving $PENDING_DIR to $TARGET_DIR (slug: $NAMESPACED_SLUG)"
              
              mkdir -p "$(dirname "$TARGET_DIR")"
              
              if [ -d "$TARGET_DIR" ]; then
                rm -rf "$TARGET_DIR"
              fi
              
              mv "$PENDING_DIR" "$TARGET_DIR"
              
              jq --arg path "$TARGET_DIR" '.path = $path' \
                "$TARGET_DIR/marketplace-entry.json" > /tmp/entry.json
              mv /tmp/entry.json "$TARGET_DIR/marketplace-entry.json"
            fi
          done

      - name: Update marketplace.json
        run: |
          for entry_file in $(find plugins -name "marketplace-entry.json" -newer .claude-plugin/marketplace.json 2>/dev/null || find plugins -name "marketplace-entry.json" 2>/dev/null); do
            NAMESPACED_SLUG=$(jq -r '.slug' "$entry_file")
            
            EXISTING=$(jq --arg name "$NAMESPACED_SLUG" '.plugins | map(select(.name == $name)) | length' .claude-plugin/marketplace.json)
            
            if [ "$EXISTING" -gt "0" ]; then
              echo "Plugin $NAMESPACED_SLUG already in marketplace, updating..."
              jq --arg name "$NAMESPACED_SLUG" --slurpfile entry "$entry_file" \
                '.plugins = [.plugins[] | if .name == $name then $entry[0] else . end]' \
                .claude-plugin/marketplace.json > /tmp/marketplace.json
            else
              echo "Adding new plugin $NAMESPACED_SLUG to marketplace..."
              jq --slurpfile entry "$entry_file" \
                '.plugins += $entry' \
                .claude-plugin/marketplace.json > /tmp/marketplace.json
            fi
            
            mv /tmp/marketplace.json .claude-plugin/marketplace.json
          done
          
          echo "Updated marketplace.json:"
          jq '.plugins | length' .claude-plugin/marketplace.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage all changes including deletions from pending/
          git add -A
          
          if [ -d "pending" ] && [ -z "$(ls -A pending 2>/dev/null)" ]; then
            rmdir pending 2>/dev/null || true
          fi
          
          PLUGINS="${{ steps.find_pending.outputs.plugins }}"
          git commit -m "Approve plugins: $PLUGINS" || echo "No changes to commit"
          
          # Handle race conditions: pull --rebase before push
          # Retry up to 3 times in case of concurrent pushes
          for i in 1 2 3; do
            git pull --rebase origin main && git push origin main && break
            echo "Push failed, retrying ($i/3)..."
            sleep 2
          done
