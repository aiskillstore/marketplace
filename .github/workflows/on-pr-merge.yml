name: On PR Merge - Approve Skill

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  approve-skill:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'pending-review')
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Find pending skills and commit to skills directory
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail

          # Use temp directory for clean git operations
          WORK_DIR="/tmp/marketplace-approve-${{ github.run_id }}"

          cleanup() {
            echo "üßπ Cleaning up temp directory..."
            rm -rf "$WORK_DIR" 2>/dev/null || true
          }
          trap cleanup EXIT

          echo "üì¶ Cloning fresh repository to $WORK_DIR..."
          git clone --depth 1 "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ github.repository }}.git" "$WORK_DIR"
          cd "$WORK_DIR"

          git config user.name "ai-skill-store[bot]"
          git config user.email "2628292+ai-skill-store[bot]@users.noreply.github.com"

          # Find pending skills by looking for SKILL.md files
          SKILL_PATHS=""
          SKILL_NAMES=""

          for skill_file in $(find pending -name "SKILL.md" 2>/dev/null); do
            SKILL_DIR=$(dirname "$skill_file")
            SKILL_PATHS="$SKILL_PATHS $SKILL_DIR"

            # Extract skill name from directory for commit message
            NAME=$(basename "$SKILL_DIR")
            SKILL_NAMES="$SKILL_NAMES /$NAME"
          done

          if [ -z "$SKILL_PATHS" ]; then
            echo "No pending skills found to approve"
            exit 0
          fi

          echo "Found pending skills:$SKILL_PATHS"

          echo "=== Moving skills from pending to skills ==="
          for PENDING_DIR in $SKILL_PATHS; do
            if [ -d "$PENDING_DIR" ] && [ -f "$PENDING_DIR/SKILL.md" ]; then
              # Extract author (org) from pending path: pending/author/skill-name -> author
              # Target path: skills/author/skill-name
              AUTHOR=$(echo "$PENDING_DIR" | cut -d'/' -f2)
              SKILL_NAME=$(basename "$PENDING_DIR")
              TARGET_DIR="skills/$AUTHOR/$SKILL_NAME"

              echo "Moving $PENDING_DIR to $TARGET_DIR"

              mkdir -p "$(dirname "$TARGET_DIR")"

              if [ -d "$TARGET_DIR" ]; then
                rm -rf "$TARGET_DIR"
              fi

              mv "$PENDING_DIR" "$TARGET_DIR"
            fi
          done

          echo "=== Committing and pushing ==="
          # Stage all changes including deletions from pending/
          git add -A

          # Remove empty pending directory
          if [ -d "pending" ] && [ -z "$(ls -A pending 2>/dev/null)" ]; then
            rmdir pending 2>/dev/null || true
            git add -A
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Approve skills:$SKILL_NAMES"
            
            # Push with retry for race conditions
            for i in 1 2 3; do
              if git push origin main; then
                echo "‚úÖ Successfully pushed to main"
                break
              fi
              echo "Push failed, pulling latest and retrying ($i/3)..."
              git pull --rebase origin main || {
                # If rebase fails, abort and retry with fresh state
                git rebase --abort 2>/dev/null || true
                git reset --hard origin/main
                git cherry-pick HEAD@{1} || true
              }
              sleep 2
            done
          fi

      - name: Extract submission ID from PR body
        id: extract_submission
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Extract submission ID from PR body: **Submission ID**: `UUID`
          # Use grep with PCRE or sed to extract UUID pattern
          SUBMISSION_ID=$(echo "$PR_BODY" | grep -oE 'Submission ID.*`[0-9a-f-]{36}`' | grep -oE '[0-9a-f-]{36}' || echo "")
          echo "submission_id=$SUBMISSION_ID" >> $GITHUB_OUTPUT
          if [ -n "$SUBMISSION_ID" ]; then
            echo "üìã Found submission ID: $SUBMISSION_ID"
          else
            echo "‚ö†Ô∏è No submission ID found in PR body"
          fi

      - name: Notify skillstore - Merged
        if: steps.extract_submission.outputs.submission_id != ''
        env:
          SUBMISSION_ID: ${{ steps.extract_submission.outputs.submission_id }}
          SKILLSTORE_API_URL: ${{ secrets.SKILLSTORE_API_URL }}
          SKILLSTORE_CALLBACK_TOKEN: ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
        run: |
          echo "üì§ Notifying skillstore: submission $SUBMISSION_ID merged"
          curl -sS -X POST "$SKILLSTORE_API_URL/api/submit/callback" \
            -H "Authorization: Bearer $SKILLSTORE_CALLBACK_TOKEN" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/SkillstoreBot" \
            -H "X-Skillstore-Callback: true" \
            -d '{
              "submission_id": "'"$SUBMISSION_ID"'",
              "event": "merged",
              "pr_url": "'"$PR_URL"'",
              "pr_number": '"$PR_NUMBER"',
              "merged_by": "'"$MERGED_BY"'",
              "workflow_run_id": ${{ github.run_id }},
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "::warning::Failed to notify skillstore"
