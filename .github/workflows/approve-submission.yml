# Manual Approval Workflow for Large Submissions
#
# This workflow processes submissions that require admin approval:
# - Repos with >50 skills
# - Repos flagged by security checks
#
# Triggered manually by repository admins via workflow_dispatch.
# Uses GitHub Environment protection rules for additional approval gate.

name: Approve & Process Submission

on:
  workflow_dispatch:
    inputs:
      submission_id:
        description: 'Submission ID to approve and process'
        required: true
        type: string
      github_url:
        description: 'GitHub URL (auto-filled from submission)'
        required: true
        type: string
      model:
        description: 'Model to use (e.g., gpt-5.2-codex:high, claude-sonnet-4.5)'
        required: false
        type: string
        default: ''
      cli_version:
        description: 'CLI version (default: latest)'
        required: false
        type: string
        default: 'latest'
      max_parallel:
        description: 'Max parallel shards (default: 6)'
        type: string
        default: '6'

env:
  SUBMISSION_ID: ${{ inputs.submission_id }}
  GITHUB_URL: ${{ inputs.github_url }}

concurrency:
  group: approve-submission-${{ inputs.submission_id }}
  cancel-in-progress: false

jobs:
  # ============================================================
  # JOB 1: APPROVAL GATE
  # Requires manual approval in GitHub UI via environment protection
  # ============================================================
  approve:
    runs-on: self-hosted
    timeout-minutes: 1440  # 24 hours for manual approval wait
    environment: production  # Requires manual approval configured in repo settings
    steps:
      - name: Record approval
        run: |
          echo "âœ… Submission ${{ inputs.submission_id }} approved by ${{ github.actor }}"
          echo "URL: ${{ inputs.github_url }}"

      - name: Notify skillstore - Approved
        run: |
          curl -sS -X POST "${{ secrets.SKILLSTORE_API_URL }}/api/submit/callback" \
            -H "Authorization: Bearer ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/SkillstoreBot" \
            -H "X-Skillstore-Callback: true" \
            -d '{
              "submission_id": "'"${{ inputs.submission_id }}"'",
              "event": "approved",
              "approved_by": "'"${{ github.actor }}"'",
              "workflow_run_id": ${{ github.run_id }},
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "::warning::Failed to notify skillstore"

  # ============================================================
  # JOB 2: PROCESS SKILLS (Reusable Workflow)
  # Discovers, processes, and creates PR for approved submission
  # ============================================================
  process-skills:
    needs: approve
    uses: ./.github/workflows/reusable-process-skills.yml
    with:
      github_url: ${{ inputs.github_url }}
      submission_id: ${{ inputs.submission_id }}
      model: ${{ inputs.model }}
      cli_version: ${{ inputs.cli_version }}
      max_parallel: ${{ inputs.max_parallel }}
      is_manual_approval: true
      approved_by: ${{ github.actor }}
    secrets:
      APP_ID: ${{ secrets.APP_ID }}
      APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
      SKILLSTORE_AGENTS: ${{ vars.SKILLSTORE_AGENTS }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      SKILLSTORE_API_URL: ${{ secrets.SKILLSTORE_API_URL }}
      SKILLSTORE_CALLBACK_TOKEN: ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}

  # ============================================================
  # JOB 3: NOTIFICATIONS AND SUMMARY
  # Sends callbacks to skillstore API and creates workflow summary
  # ============================================================
  notify:
    needs: [approve, process-skills]
    if: always()
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Notify skillstore - PR created
        if: needs.process-skills.outputs.pr_url
        env:
          PR_URL: ${{ needs.process-skills.outputs.pr_url }}
          PROCESSED_COUNT: ${{ needs.process-skills.outputs.processed_count }}
          HIGHEST_RISK: ${{ needs.process-skills.outputs.highest_risk }}
        run: |
          curl -sS -X POST "${{ secrets.SKILLSTORE_API_URL }}/api/submit/callback" \
            -H "Authorization: Bearer ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/SkillstoreBot" \
            -H "X-Skillstore-Callback: true" \
            -d '{
              "submission_id": "'"${{ env.SUBMISSION_ID }}"'",
              "event": "pr_created",
              "pr_url": "'"$PR_URL"'",
              "processed_count": '"$PROCESSED_COUNT"',
              "approved_by": "'"${{ github.actor }}"'",
              "workflow_run_id": ${{ github.run_id }},
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "::warning::Failed to notify skillstore"

      - name: Notify skillstore - Failed
        if: needs.process-skills.result == 'failure'
        run: |
          curl -sS -X POST "${{ secrets.SKILLSTORE_API_URL }}/api/submit/callback" \
            -H "Authorization: Bearer ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/SkillstoreBot" \
            -H "X-Skillstore-Callback: true" \
            -d '{
              "submission_id": "'"${{ env.SUBMISSION_ID }}"'",
              "event": "failed",
              "error_message": "Processing workflow failed. Check GitHub Actions log for details.",
              "workflow_run_id": ${{ github.run_id }},
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "::warning::Failed to notify skillstore"

      - name: Summary
        if: always()
        env:
          PR_URL: ${{ needs.process-skills.outputs.pr_url }}
          PROCESSED_COUNT: ${{ needs.process-skills.outputs.processed_count }}
          HIGHEST_RISK: ${{ needs.process-skills.outputs.highest_risk }}
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Processing Summary (Manual Approval)

          **Source**: ${{ env.GITHUB_URL }}
          **Submission ID**: \`${{ env.SUBMISSION_ID }}\`
          **Approved by**: @${{ github.actor }}

          | Metric | Value |
          |--------|-------|
          | Workflow Status | ${{ needs.process-skills.result }} |
          | Successfully Processed | ${PROCESSED_COUNT:-N/A} |
          | Highest Risk | ${HIGHEST_RISK:-N/A} |

          EOF

          if [ -n "$PR_URL" ]; then
            echo "ðŸ”— **PR Created**: $PR_URL" >> $GITHUB_STEP_SUMMARY
          fi
