name: Validate Marketplace

on:
  push:
    branches: [main]
    paths:
      # Only validate approved plugins on push to main
      # pending/** is validated via PR, no need to re-validate after merge
      - '.claude-plugin/marketplace.json'
      - 'plugins/**/.claude-plugin/plugin.json'
      - 'plugins/**/skill-report.json'
  pull_request:
    branches: [main]
    paths:
      # Validate both pending and plugins on PR (CI gate)
      - '.claude-plugin/marketplace.json'
      - 'plugins/**/.claude-plugin/plugin.json'
      - 'plugins/**/skill-report.json'
      - 'pending/**/.claude-plugin/plugin.json'
      - 'pending/**/skill-report.json'
  workflow_dispatch:

env:
  # Enable auto-fix for PRs (set to 'false' to disable)
  AUTO_FIX_ENABLED: ${{ github.event_name == 'pull_request' }}

jobs:
  validate:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install dependencies
        run: npm install ajv ajv-formats

      - name: Validate marketplace.json
        run: |
          node -e "
            const Ajv = require('ajv');
            const addFormats = require('ajv-formats');
            const fs = require('fs');
            
            const ajv = new Ajv({ allErrors: true });
            addFormats(ajv);
            
            const schema = JSON.parse(fs.readFileSync('schemas/marketplace.schema.json', 'utf8'));
            const data = JSON.parse(fs.readFileSync('.claude-plugin/marketplace.json', 'utf8'));
            
            const validate = ajv.compile(schema);
            const valid = validate(data);
            
            if (!valid) {
              console.error('Validation errors:', JSON.stringify(validate.errors, null, 2));
              process.exit(1);
            }
            console.log('marketplace.json is valid');
          "

      - name: Validate all plugin.json files
        run: |
          node -e "
            const Ajv = require('ajv');
            const addFormats = require('ajv-formats');
            const fs = require('fs');
            const path = require('path');
            const { globSync } = require('fs');
            
            const ajv = new Ajv({ allErrors: true });
            addFormats(ajv);
            
            const schema = JSON.parse(fs.readFileSync('schemas/plugin.schema.json', 'utf8'));
            const validate = ajv.compile(schema);
            
            let hasErrors = false;
            
            // Find all plugin.json files
            const pluginFiles = [];
            const findPluginJsons = (dir) => {
              if (!fs.existsSync(dir)) return;
              const entries = fs.readdirSync(dir, { withFileTypes: true });
              for (const entry of entries) {
                const fullPath = path.join(dir, entry.name);
                if (entry.isDirectory()) {
                  findPluginJsons(fullPath);
                } else if (entry.name === 'plugin.json') {
                  pluginFiles.push(fullPath);
                }
              }
            };
            
            findPluginJsons('plugins');
            findPluginJsons('pending');
            
            for (const file of pluginFiles) {
              try {
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                const valid = validate(data);
                if (!valid) {
                  console.error(\`Validation errors in \${file}:\`, JSON.stringify(validate.errors, null, 2));
                  hasErrors = true;
                } else {
                  console.log(\`\${file} is valid\`);
                }
              } catch (e) {
                console.error(\`Error reading \${file}:\`, e.message);
                hasErrors = true;
              }
            }
            
            if (hasErrors) process.exit(1);
            console.log('All plugin.json files are valid');
          "

      - name: Check marketplace consistency
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const marketplace = JSON.parse(fs.readFileSync('.claude-plugin/marketplace.json', 'utf8'));
            
            let hasErrors = false;
            
            for (const plugin of marketplace.plugins) {
              const pluginPath = plugin.source;
              const manifestPath = path.join(pluginPath, '.claude-plugin', 'plugin.json');
              
              if (!fs.existsSync(pluginPath)) {
                console.error(\`Plugin directory not found: \${pluginPath}\`);
                hasErrors = true;
                continue;
              }
              
              if (!fs.existsSync(manifestPath)) {
                console.error(\`Plugin manifest not found: \${manifestPath}\`);
                hasErrors = true;
                continue;
              }
              
              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              if (manifest.name !== plugin.name) {
                console.error(\`Plugin name mismatch: marketplace says '\${plugin.name}' but manifest says '\${manifest.name}'\`);
                hasErrors = true;
              }
              
              console.log(\`Plugin '\${plugin.name}' is consistent\`);
            }
            
            if (hasErrors) process.exit(1);
            console.log('Marketplace is consistent with all plugins');
          "

      - name: Validate skill-report.json files
        id: validate-skill-reports
        continue-on-error: true
        run: |
          node -e "
            const Ajv = require('ajv');
            const addFormats = require('ajv-formats');
            const fs = require('fs');
            const path = require('path');
            
            const ajv = new Ajv({ allErrors: true });
            addFormats(ajv);
            
            const schema = JSON.parse(fs.readFileSync('schemas/skill-report.schema.json', 'utf8'));
            const validate = ajv.compile(schema);
            
            let hasErrors = false;
            
            const findReportFiles = (dir) => {
              const files = [];
              if (!fs.existsSync(dir)) return files;
              const entries = fs.readdirSync(dir, { withFileTypes: true });
              for (const entry of entries) {
                const fullPath = path.join(dir, entry.name);
                if (entry.isDirectory()) {
                  files.push(...findReportFiles(fullPath));
                } else if (entry.name === 'skill-report.json') {
                  files.push(fullPath);
                }
              }
              return files;
            };
            
            const reportFiles = [...findReportFiles('plugins'), ...findReportFiles('pending')];
            
            for (const file of reportFiles) {
              try {
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                const valid = validate(data);
                if (!valid) {
                  console.error(\`Validation errors in \${file}:\`, JSON.stringify(validate.errors, null, 2));
                  hasErrors = true;
                } else {
                  console.log(\`\${file} is valid\`);
                }
              } catch (e) {
                console.error(\`Error reading \${file}:\`, e.message);
                hasErrors = true;
              }
            }
            
            if (hasErrors) process.exit(1);
            if (reportFiles.length === 0) {
              console.log('No skill-report.json files found (OK for empty marketplace)');
            } else {
              console.log('All skill-report.json files are valid');
            }
          "

      - name: Download skillstore CLI for auto-fix
        if: steps.validate-skill-reports.outcome == 'failure' && env.AUTO_FIX_ENABLED == 'true'
        id: download-cli
        uses: ./.github/actions/download-skillstore-cli
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Auto-fix skill-report.json validation errors
        if: steps.validate-skill-reports.outcome == 'failure' && env.AUTO_FIX_ENABLED == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLI_PATH: ${{ steps.download-cli.outputs.cli-path }}
        run: |
          echo "::notice::Validation failed. Attempting AI-powered auto-fix..."
          echo "Running AI-powered fix on plugins directory..."
          "$CLI_PATH" skill fix ./plugins --schema ./schemas/skill-report.schema.json --verbose || true
          
          echo "Running AI-powered fix on pending directory..."
          "$CLI_PATH" skill fix ./pending --schema ./schemas/skill-report.schema.json --verbose || true
          
          echo "::notice::Auto-fix completed. Re-validating..."

      - name: Re-validate after auto-fix
        if: steps.validate-skill-reports.outcome == 'failure' && env.AUTO_FIX_ENABLED == 'true'
        id: revalidate
        run: |
          node -e "
            const Ajv = require('ajv');
            const addFormats = require('ajv-formats');
            const fs = require('fs');
            const path = require('path');
            
            const ajv = new Ajv({ allErrors: true });
            addFormats(ajv);
            
            const schema = JSON.parse(fs.readFileSync('schemas/skill-report.schema.json', 'utf8'));
            const validate = ajv.compile(schema);
            
            let hasErrors = false;
            let fixedCount = 0;
            let totalCount = 0;
            
            const findReportFiles = (dir) => {
              const files = [];
              if (!fs.existsSync(dir)) return files;
              const entries = fs.readdirSync(dir, { withFileTypes: true });
              for (const entry of entries) {
                const fullPath = path.join(dir, entry.name);
                if (entry.isDirectory()) {
                  files.push(...findReportFiles(fullPath));
                } else if (entry.name === 'skill-report.json') {
                  files.push(fullPath);
                }
              }
              return files;
            };
            
            const reportFiles = [...findReportFiles('plugins'), ...findReportFiles('pending')];
            totalCount = reportFiles.length;
            
            for (const file of reportFiles) {
              try {
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                const valid = validate(data);
                if (!valid) {
                  console.error(\`Still invalid: \${file}\`);
                  hasErrors = true;
                } else {
                  fixedCount++;
                  console.log(\`Valid: \${file}\`);
                }
              } catch (e) {
                console.error(\`Error reading \${file}:\`, e.message);
                hasErrors = true;
              }
            }
            
            console.log(\`\nValidation summary: \${fixedCount}/\${totalCount} files valid\`);
            
            if (hasErrors) {
              console.error('Some files still have validation errors after auto-fix');
              process.exit(1);
            }
            console.log('All skill-report.json files are now valid after auto-fix');
          "

      - name: Commit auto-fixed files
        if: steps.validate-skill-reports.outcome == 'failure' && env.AUTO_FIX_ENABLED == 'true' && steps.revalidate.outcome == 'success'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add plugins/**/skill-report.json pending/**/skill-report.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "fix: auto-fix skill-report.json validation errors"
            git push origin HEAD:${{ github.head_ref }}
            echo "::notice::Auto-fixed files committed and pushed to PR branch"
          fi

      - name: Add summary
        if: always()
        run: |
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate-skill-reports.outcome }}" == "success" ]; then
            echo "âœ… All skill-report.json files passed validation" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.revalidate.outcome }}" == "success" ]; then
            echo "ðŸ”§ Validation errors were automatically fixed by AI" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The fixes have been committed to this PR. Please review the changes." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Validation failed" >> $GITHUB_STEP_SUMMARY
            if [ "${{ env.AUTO_FIX_ENABLED }}" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Auto-fix was attempted but some errors could not be resolved automatically." >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Fail if validation errors remain
        if: steps.validate-skill-reports.outcome == 'failure' && (env.AUTO_FIX_ENABLED != 'true' || steps.revalidate.outcome == 'failure')
        run: |
          echo "::error::skill-report.json validation failed"
          exit 1
