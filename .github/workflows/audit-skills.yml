name: Audit All Skills

on:
  workflow_dispatch:
    inputs:
      agent:
        description: 'AI agent for audit'
        type: choice
        options:
          - 'auto'
          - 'codex'
          - 'claude'
          - 'gemini'
        default: 'auto'
      slug:
        description: 'Audit specific skill only (leave empty for all)'
        type: string
        default: ''
      limit:
        description: 'Maximum skills to process (leave empty for all)'
        type: string
        default: ''
      cli_version:
        description: 'CLI version (default: latest)'
        type: string
        default: 'latest'
      dry_run:
        description: 'Preview changes without creating PR'
        type: boolean
        default: false

env:
  CLI_REPO: aiskillstore/skillstore
  CLI_VERSION: ${{ inputs.cli_version || 'latest' }}

concurrency:
  group: audit-skills
  cancel-in-progress: false

jobs:
  audit:
    runs-on: self-hosted
    outputs:
      updated_count: ${{ steps.audit.outputs.updated_count }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 1

      - name: Configure Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download Skillstore CLI
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Downloading skillstore-cli..."
          
          if [ "$CLI_VERSION" = "latest" ]; then
            echo "Fetching latest release tag..."
            RELEASE_TAG=$(gh release view --repo "$CLI_REPO" --json tagName -q '.tagName')
            echo "Latest release: $RELEASE_TAG"
          else
            RELEASE_TAG="cli-v$CLI_VERSION"
            echo "Using specified version: $RELEASE_TAG"
          fi
          
          gh release download "$RELEASE_TAG" \
            --repo "$CLI_REPO" \
            --pattern "skillstore-cli-linux-x64" \
            --output skillstore-cli
          
          chmod +x skillstore-cli
          
          echo "CLI version:"
          ./skillstore-cli --version

      - name: Audit skills
        id: audit
        env:
          SKILLSTORE_AGENTS: ${{ secrets.SKILLSTORE_AGENTS }}
        run: |
          echo "Auditing skills..."
          echo "Agent: ${{ inputs.agent }}"
          echo "Dry run: ${{ inputs.dry_run }}"
          
          AGENT_FLAG=""
          if [ -n "${{ inputs.agent }}" ] && [ "${{ inputs.agent }}" != "auto" ]; then
            AGENT_FLAG="--agent ${{ inputs.agent }}"
          fi
          
          SLUG_FLAG=""
          if [ -n "${{ inputs.slug }}" ]; then
            SLUG_FLAG="--slug ${{ inputs.slug }}"
          fi
          
          LIMIT_FLAG=""
          if [ -n "${{ inputs.limit }}" ]; then
            LIMIT_FLAG="--limit ${{ inputs.limit }}"
          fi
          
          DRY_RUN_FLAG=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          
          ./skillstore-cli skill audit ./plugins \
            $AGENT_FLAG \
            $SLUG_FLAG \
            $LIMIT_FLAG \
            $DRY_RUN_FLAG \
            --verbose \
            2>&1 | tee audit-output.log
          
          UPDATED_COUNT=$(grep -c "✅ updated" audit-output.log || echo "0")
          echo "updated_count=$UPDATED_COUNT" >> $GITHUB_OUTPUT
          echo "Updated $UPDATED_COUNT skill(s)"

      - name: Check for changes
        id: changes
        if: inputs.dry_run != true
        run: |
          if git diff --quiet plugins/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            CHANGED_FILES=$(git diff --name-only plugins/ | wc -l | tr -d ' ')
            echo "Changed files: $CHANGED_FILES"
          fi

      - name: Create Pull Request
        id: pr
        if: inputs.dry_run != true && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          BRANCH_NAME="audit/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          git add plugins/*/skill-report.json
          git add plugins/*/*/skill-report.json 2>/dev/null || true
          
          UPDATED_COUNT="${{ steps.audit.outputs.updated_count }}"
          AGENT="${{ inputs.agent }}"
          
          git commit -m "chore(audit): audit ${UPDATED_COUNT} skills with AI risk factor detection

          - Agent: ${AGENT}
          - Updated risk_factors field with: scripts, network, filesystem, env_access, external_commands
          - Refreshed security_audit and content sections"
          
          git push origin "$BRANCH_NAME"
          
          PR_URL=$(gh pr create \
            --title "Audit ${UPDATED_COUNT} skills with AI risk factor detection" \
            --body "$(cat <<'EOF'
          ## Summary

          This PR audits skills in the marketplace using AI-powered security analysis.

          ### Changes
          - Updated `risk_factors` field in each skill's `skill-report.json`
          - Risk factors detected: `scripts`, `network`, `filesystem`, `env_access`, `external_commands`
          - Refreshed `security_audit` section with latest analysis
          - Updated `content` section with AI-generated marketplace content

          ### Configuration
          - **Agent**: ${{ inputs.agent }}
          - **CLI Version**: ${{ env.CLI_VERSION }}

          ### Updated Skills
          ${{ steps.audit.outputs.updated_count }} skill(s) updated

          ### After Merge
          The `sync-to-supabase.yml` workflow will automatically update the database with new risk factors.
          EOF
          )" \
            --base main \
            --head "$BRANCH_NAME")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "::notice::Created PR: $PR_URL"

      - name: Summary
        run: |
          echo "## Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Agent | \`${{ inputs.agent }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Skills Updated | ${{ steps.audit.outputs.updated_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.pr.outputs.pr_url }}" != "" ]; then
            echo "| PR | ${{ steps.pr.outputs.pr_url }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Audit workflow completed." >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -f skillstore-cli audit-output.log
