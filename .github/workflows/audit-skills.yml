name: Audit All Skills

on:
  workflow_dispatch:
    inputs:
      agent:
        description: 'AI agent for audit'
        type: choice
        options:
          - 'auto'
          - 'codex'
          - 'claude'
          - 'gemini'
        default: 'auto'
      slug:
        description: 'Audit specific skill only (leave empty for all)'
        type: string
        default: ''
      limit:
        description: 'Maximum skills to process (leave empty for all)'
        type: string
        default: ''
      correlation_id:
        description: 'Correlation ID for chained runs (auto-set on continuation)'
        type: string
        default: ''
      resume_from_run:
        description: 'Run ID to resume from (auto-set on continuation)'
        type: string
        default: ''
      cli_version:
        description: 'CLI version (default: latest)'
        type: string
        default: 'latest'
      dry_run:
        description: 'Preview changes without creating PR'
        type: boolean
        default: false
      max_runtime_minutes:
        description: 'Max runtime before continuation dispatch (default: 330 = 5.5h)'
        type: string
        default: '330'

env:
  CLI_REPO: aiskillstore/skillstore
  CLI_VERSION: ${{ inputs.cli_version || 'latest' }}
  CHECKPOINT_FILE: audit-checkpoint.json

concurrency:
  group: audit-skills-${{ inputs.correlation_id || github.run_id }}
  cancel-in-progress: false

jobs:
  audit:
    runs-on: self-hosted
    timeout-minutes: 360
    outputs:
      completed: ${{ steps.audit.outputs.completed }}
      remaining: ${{ steps.audit.outputs.remaining }}
      failed: ${{ steps.audit.outputs.failed }}
      exit_reason: ${{ steps.audit.outputs.exit_reason }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
      correlation_id: ${{ steps.correlation.outputs.id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 1

      - name: Configure Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set correlation ID
        id: correlation
        run: |
          if [ -n "${{ inputs.correlation_id }}" ]; then
            CORR_ID="${{ inputs.correlation_id }}"
          else
            CORR_ID="${{ github.run_id }}"
          fi
          echo "id=$CORR_ID" >> $GITHUB_OUTPUT
          echo "Correlation ID: $CORR_ID"

      - name: Restore checkpoint from previous run
        if: inputs.resume_from_run != ''
        uses: actions/download-artifact@v4
        with:
          name: audit-checkpoint-${{ inputs.resume_from_run }}
          path: .
        continue-on-error: true

      - name: Download Skillstore CLI
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Downloading skillstore-cli..."
          
          if [ "$CLI_VERSION" = "latest" ]; then
            echo "Fetching latest release tag..."
            RELEASE_TAG=$(gh release view --repo "$CLI_REPO" --json tagName -q '.tagName')
            echo "Latest release: $RELEASE_TAG"
          else
            RELEASE_TAG="cli-v$CLI_VERSION"
            echo "Using specified version: $RELEASE_TAG"
          fi
          
          gh release download "$RELEASE_TAG" \
            --repo "$CLI_REPO" \
            --pattern "skillstore-cli-linux-x64" \
            --output skillstore-cli
          
          chmod +x skillstore-cli
          
          echo "CLI version:"
          ./skillstore-cli --version

      - name: Audit skills with checkpoint
        id: audit
        env:
          SKILLSTORE_AGENTS: ${{ secrets.SKILLSTORE_AGENTS }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          echo "Starting audit..."
          echo "Correlation ID: ${{ steps.correlation.outputs.id }}"
          
          MAX_RUNTIME_MS=$(( ${{ inputs.max_runtime_minutes || '330' }} * 60000 ))
          echo "Max runtime: $(( MAX_RUNTIME_MS / 60000 )) minutes"
          
          AGENT_FLAG=""
          if [ -n "${{ inputs.agent }}" ] && [ "${{ inputs.agent }}" != "auto" ]; then
            AGENT_FLAG="--agent ${{ inputs.agent }}"
          fi
          
          SLUG_FLAG=""
          if [ -n "${{ inputs.slug }}" ]; then
            SLUG_FLAG="--slug ${{ inputs.slug }}"
          fi
          
          LIMIT_FLAG=""
          if [ -n "${{ inputs.limit }}" ]; then
            LIMIT_FLAG="--limit ${{ inputs.limit }}"
          fi
          
          DRY_RUN_FLAG=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          
          RESUME_FLAG=""
          if [ -n "${{ inputs.resume_from_run }}" ] && [ -f "$CHECKPOINT_FILE" ]; then
            RESUME_FLAG="--resume"
            echo "Resuming from checkpoint..."
          fi
          
          ./skillstore-cli skill audit ./plugins \
            $AGENT_FLAG \
            $SLUG_FLAG \
            $LIMIT_FLAG \
            $DRY_RUN_FLAG \
            $RESUME_FLAG \
            --checkpoint-file "$CHECKPOINT_FILE" \
            --correlation-id "${{ steps.correlation.outputs.id }}" \
            --max-runtime-ms "$MAX_RUNTIME_MS" \
            --verbose \
            2>&1 | tee audit-output.log
          
          EXIT_CODE=$?
          
          if [ -f "$CHECKPOINT_FILE" ]; then
            COMPLETED=$(jq -r '.completed_skills | length' "$CHECKPOINT_FILE" 2>/dev/null || echo "0")
            TOTAL=$(jq -r '.total_skills' "$CHECKPOINT_FILE" 2>/dev/null || echo "0")
            REMAINING=$((TOTAL - COMPLETED))
            FAILED=$(jq -r '.failed_skills | length' "$CHECKPOINT_FILE" 2>/dev/null || echo "0")
            EXIT_REASON=$(jq -r '.exit_reason // "unknown"' "$CHECKPOINT_FILE" 2>/dev/null || echo "unknown")
          else
            COMPLETED=$(grep -c "âœ… updated" audit-output.log 2>/dev/null || echo "0")
            TOTAL=$COMPLETED
            REMAINING=0
            FAILED=$(grep -c "âŒ error" audit-output.log 2>/dev/null || echo "0")
            EXIT_REASON="complete"
          fi
          
          echo "completed=$COMPLETED" >> $GITHUB_OUTPUT
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "exit_reason=$EXIT_REASON" >> $GITHUB_OUTPUT
          
          echo "=== Audit Summary ==="
          echo "Completed: $COMPLETED"
          echo "Remaining: $REMAINING"
          echo "Failed: $FAILED"
          echo "Exit reason: $EXIT_REASON"

      - name: Upload checkpoint artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-checkpoint-${{ github.run_id }}
          path: ${{ env.CHECKPOINT_FILE }}
          retention-days: 7
          if-no-files-found: ignore

      - name: Dispatch continuation workflow
        if: steps.audit.outputs.remaining != '0' && steps.audit.outputs.exit_reason == 'time-limit'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "ðŸ”„ Time limit reached with ${{ steps.audit.outputs.remaining }} skills remaining"
          echo "Dispatching continuation workflow..."
          
          gh workflow run audit-skills.yml \
            --ref ${{ github.ref }} \
            -f agent=${{ inputs.agent }} \
            -f correlation_id=${{ steps.correlation.outputs.id }} \
            -f resume_from_run=${{ github.run_id }} \
            -f cli_version=${{ inputs.cli_version || 'latest' }} \
            -f max_runtime_minutes=${{ inputs.max_runtime_minutes || '330' }}
          
          echo "::notice::Continuation workflow dispatched. Skills remaining: ${{ steps.audit.outputs.remaining }}"

      - name: Check for changes
        id: changes
        if: inputs.dry_run != true && steps.audit.outputs.exit_reason == 'complete'
        run: |
          if git diff --quiet plugins/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            CHANGED_FILES=$(git diff --name-only plugins/ | wc -l | tr -d ' ')
            echo "Changed files: $CHANGED_FILES"
          fi

      - name: Create Pull Request
        id: pr
        if: inputs.dry_run != true && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          BRANCH_NAME="audit/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          git add plugins/*/skill-report.json
          git add plugins/*/*/skill-report.json 2>/dev/null || true
          
          COMPLETED="${{ steps.audit.outputs.completed }}"
          FAILED="${{ steps.audit.outputs.failed }}"
          AGENT="${{ inputs.agent }}"
          
          git commit -m "chore(audit): audit ${COMPLETED} skills with AI risk factor detection

          - Agent: ${AGENT}
          - Updated: ${COMPLETED}
          - Failed: ${FAILED}
          - Correlation: ${{ steps.correlation.outputs.id }}"
          
          git push origin "$BRANCH_NAME"
          
          PR_URL=$(gh pr create \
            --title "Audit ${COMPLETED} skills with AI risk factor detection" \
            --body "$(cat <<EOF
          ## Summary
          
          Batch audit of skills with AI-powered security analysis.
          
          | Metric | Value |
          |--------|-------|
          | Completed | ${COMPLETED} |
          | Failed | ${FAILED} |
          | Agent | \`${AGENT}\` |
          | Correlation ID | \`${{ steps.correlation.outputs.id }}\` |
          | CLI Version | \`${{ env.CLI_VERSION }}\` |
          
          ### Changes
          - Updated \`risk_factors\` field in each skill's \`skill-report.json\`
          - Risk factors detected: \`scripts\`, \`network\`, \`filesystem\`, \`env_access\`, \`external_commands\`
          - Refreshed \`security_audit\` section with latest analysis
          
          ### After Merge
          The \`sync-to-supabase.yml\` workflow will automatically update the database.
          EOF
          )" \
            --base main \
            --head "$BRANCH_NAME")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "::notice::Created PR: $PR_URL"

      - name: Summary
        if: always()
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Audit Summary
          
          | Metric | Value |
          |--------|-------|
          | Agent | \`${{ inputs.agent }}\` |
          | Completed | ${{ steps.audit.outputs.completed }} |
          | Failed | ${{ steps.audit.outputs.failed }} |
          | Remaining | ${{ steps.audit.outputs.remaining }} |
          | Exit Reason | \`${{ steps.audit.outputs.exit_reason }}\` |
          | Correlation ID | \`${{ steps.correlation.outputs.id }}\` |
          | Dry Run | ${{ inputs.dry_run }} |
          
          EOF
          
          if [ "${{ steps.audit.outputs.exit_reason }}" = "time-limit" ]; then
            echo "â° **Continuation dispatched** - Next run will resume from checkpoint" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.pr.outputs.pr_url }}" ]; then
            echo "ðŸ”— **PR Created**: ${{ steps.pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f skillstore-cli audit-output.log
