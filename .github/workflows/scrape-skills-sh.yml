# Scrape Skills.sh - Daily Discovery Workflow
#
# Automatically discovers and submits new skills from skills.sh
# Runs daily at 08:00 UTC (16:00 Beijing Time)
#
# Features:
#   - Scrapes skills.sh for new skills not yet in skillstore
#   - Submits up to 10 unique skills per run
#   - Triggers process-submission workflow for each skill
#   - Provides detailed summary of discovered vs submitted skills

name: Scrape Skills.sh

on:
  schedule:
    # Run daily at 08:00 UTC (16:00 Beijing Time)
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      limit:
        description: 'Maximum skills to submit (default: 10)'
        required: false
        type: number
        default: 10
      dry_run:
        description: 'Preview only, do not submit'
        required: false
        type: boolean
        default: false

env:
  CLI_VERSION: 'latest'

jobs:
  scrape:
    name: Scrape & Submit Skills
    runs-on: ${{ github.event_name == 'schedule' && 'ubuntu-latest' || 'self-hosted' }}
    timeout-minutes: 30

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: marketplace,skillstore

      - name: Checkout marketplace
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Skillstore CLI
        uses: ./.github/actions/download-skillstore-cli
        with:
          version: ${{ env.CLI_VERSION }}
          token: ${{ steps.app-token.outputs.token }}
          cache-dir: /home/runner/_work/_cache/skillstore-cli

      - name: Run scrape-skills-sh
        id: scrape
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          GITHUB_APP_ID: ${{ secrets.APP_ID }}
          GITHUB_APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
          GITHUB_APP_INSTALLATION_ID: ${{ secrets.APP_INSTALLATION_ID }}
        run: |
          LIMIT="${{ inputs.limit || 10 }}"
          DRY_RUN="${{ inputs.dry_run || false }}"

          echo "üì° Scraping skills.sh..."
          echo "   Limit: $LIMIT"
          echo "   Dry run: $DRY_RUN"

          # Build command with JSON output and --summary flag
          CMD="$GITHUB_WORKSPACE/skillstore-cli skill scrape-skills-sh --limit $LIMIT --output json --summary"
          if [ "$DRY_RUN" = "true" ]; then
            CMD="$CMD --dry-run"
          fi

          # Run and capture output
          OUTPUT=$($CMD 2>&1) || true

          # Parse JSON using herestrings (avoids broken pipe with large output)
          TOTAL=$(jq -r '.total // 0' <<< "$OUTPUT" 2>/dev/null || echo "0")
          EXISTING=$(jq -r '.existing // 0' <<< "$OUTPUT" 2>/dev/null || echo "0")
          NEW=$(jq -r '.new // 0' <<< "$OUTPUT" 2>/dev/null || echo "0")
          SUBMITTED=$(jq -r '.submitted // 0' <<< "$OUTPUT" 2>/dev/null || echo "0")
          FAILED=$(jq -r '.failed // 0' <<< "$OUTPUT" 2>/dev/null || echo "0")

          # Display human-readable summary
          echo ""
          echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
          echo "‚îÇ         üìä Scrape Summary           ‚îÇ"
          echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
          printf "‚îÇ  Total discovered:  %6s        ‚îÇ\n" "$TOTAL"
          printf "‚îÇ  Already exists:    %6s        ‚îÇ\n" "$EXISTING"
          printf "‚îÇ  New available:     %6s        ‚îÇ\n" "$NEW"
          if [ "$DRY_RUN" != "true" ]; then
            echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
            printf "‚îÇ  ‚úÖ Submitted:      %6s        ‚îÇ\n" "$SUBMITTED"
            printf "‚îÇ  ‚ùå Failed:         %6s        ‚îÇ\n" "$FAILED"
          fi
          echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"

          # Export to outputs
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "existing=$EXISTING" >> $GITHUB_OUTPUT
          echo "new=$NEW" >> $GITHUB_OUTPUT
          echo "submitted=$SUBMITTED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT

          # Warn on failures
          if [ "$FAILED" -gt 0 ] && [ "$DRY_RUN" != "true" ]; then
            echo "::warning::$FAILED submissions failed"
          fi

      - name: Summary
        if: always()
        env:
          TOTAL: ${{ steps.scrape.outputs.total }}
          EXISTING: ${{ steps.scrape.outputs.existing }}
          NEW: ${{ steps.scrape.outputs.new }}
          SUBMITTED: ${{ steps.scrape.outputs.submitted }}
          FAILED: ${{ steps.scrape.outputs.failed }}
          DRY_RUN: ${{ steps.scrape.outputs.dry_run }}
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Skills.sh Scrape Summary

          **Run Type**: ${{ github.event_name == 'schedule' && 'Scheduled (Daily)' || 'Manual' }}
          **Dry Run**: ${DRY_RUN}
          **Limit**: ${{ inputs.limit || 10 }}

          ### Statistics

          | Metric | Count |
          |--------|-------|
          | Total skills on skills.sh | ${TOTAL:-N/A} |
          | Already in skillstore | ${EXISTING:-N/A} |
          | New (not yet imported) | ${NEW:-N/A} |
          EOF

          if [ "$DRY_RUN" != "true" ]; then
            cat << EOF >> $GITHUB_STEP_SUMMARY
          | **Submitted this run** | ${SUBMITTED:-0} |
          | Failed submissions | ${FAILED:-0} |
          EOF
          else
            cat << EOF >> $GITHUB_STEP_SUMMARY

          > ‚ÑπÔ∏è Dry run mode - no skills were submitted
          EOF
          fi

          cat << EOF >> $GITHUB_STEP_SUMMARY

          ---
          *Workflow triggered at $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
          EOF

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Skills.sh scrape workflow failed"
