name: Process Skill Submission

on:
  repository_dispatch:
    types: [process-submission]
  workflow_dispatch:
    inputs:
      github_url:
        description: 'GitHub URL of the skill to process'
        required: true
        type: string
      submitter_email:
        description: 'Submitter email (optional)'
        required: false
        type: string
      cli_version:
        description: 'CLI version (default: latest)'
        required: false
        type: string
        default: 'latest'

env:
  SUBMISSION_ID: ${{ github.event.client_payload.submission_id || github.run_id }}
  GITHUB_URL: ${{ github.event.client_payload.github_url || inputs.github_url }}
  SUBMITTER_EMAIL: ${{ github.event.client_payload.submitter_email || inputs.submitter_email || 'manual@skillstore.io' }}
  CLI_VERSION: ${{ inputs.cli_version || 'latest' }}
  CLI_REPO: aiskillstore/skillstore

jobs:
  process:
    runs-on: self-hosted
    steps:
      - name: Checkout marketplace
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Skillstore CLI
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Downloading skillstore-cli..."
          
          # Resolve version (latest â†’ actual tag)
          if [ "$CLI_VERSION" = "latest" ]; then
            echo "Fetching latest release tag..."
            RELEASE_TAG=$(gh release view --repo "$CLI_REPO" --json tagName -q '.tagName')
            echo "Latest release: $RELEASE_TAG"
          else
            RELEASE_TAG="cli-v$CLI_VERSION"
            echo "Using specified version: $RELEASE_TAG"
          fi
          
          # Download binary
          gh release download "$RELEASE_TAG" \
            --repo "$CLI_REPO" \
            --pattern "skillstore-cli-linux-x64" \
            --output skillstore-cli
          
          chmod +x skillstore-cli
          
          echo "CLI version:"
          ./skillstore-cli --version

      - name: Process submission
        id: process
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Processing: $GITHUB_URL"
          echo "Submission ID: $SUBMISSION_ID"
          
          # Run CLI with output captured
          # CLI creates pending/{slug}/ structure, so output to current dir
          ./skillstore-cli skill process "$GITHUB_URL" \
            --output . \
            --marketplace-repo "${{ github.repository }}" \
            --verbose \
            2>&1 | tee process-output.log
          
          # Extract results from CLI output (it outputs structured info)
          # The CLI handles cloning, discovery, analysis, and packaging
          
          # Check if any skills were processed
          if [ -d "pending" ] && [ "$(ls -A pending 2>/dev/null)" ]; then
            PROCESSED_SKILLS=$(ls -1 pending | tr '\n' ',' | sed 's/,$//')
            PROCESSED_COUNT=$(ls -1 pending | wc -l | tr -d ' ')
            echo "processed_count=$PROCESSED_COUNT" >> $GITHUB_OUTPUT
            echo "skills_list=$PROCESSED_SKILLS" >> $GITHUB_OUTPUT
            echo "has_results=true" >> $GITHUB_OUTPUT
            
            # Determine highest risk from reports
            HIGHEST_RISK="safe"
            for dir in pending/*/; do
              if [ -f "${dir}skill-report.json" ]; then
                RISK=$(jq -r '.security_audit.risk_level // "unknown"' "${dir}skill-report.json")
                case "$RISK" in
                  critical) HIGHEST_RISK="critical" ;;
                  high) [ "$HIGHEST_RISK" != "critical" ] && HIGHEST_RISK="high" ;;
                  medium) [ "$HIGHEST_RISK" = "safe" ] || [ "$HIGHEST_RISK" = "low" ] && HIGHEST_RISK="medium" ;;
                  low) [ "$HIGHEST_RISK" = "safe" ] && HIGHEST_RISK="low" ;;
                esac
              fi
            done
            echo "highest_risk=$HIGHEST_RISK" >> $GITHUB_OUTPUT
            
            echo "Processed $PROCESSED_COUNT skill(s): $PROCESSED_SKILLS"
            echo "Highest risk: $HIGHEST_RISK"
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
            echo "::error::No skills processed"
            exit 1
          fi

      - name: Create Pull Request
        if: steps.process.outputs.has_results == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROCESSED_COUNT="${{ steps.process.outputs.processed_count }}"
          SKILLS_LIST="${{ steps.process.outputs.skills_list }}"
          HIGHEST_RISK="${{ steps.process.outputs.highest_risk }}"
          
          # Extract repo name from URL
          REPO_NAME=$(echo "$GITHUB_URL" | sed -E 's|.*/([^/]+)/?$|\1|' | sed 's/\.git$//')
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="submission/${REPO_NAME}-${SUBMISSION_ID}"
          git checkout -b "$BRANCH_NAME"
          git add pending/
          
          if [ "$PROCESSED_COUNT" -eq 1 ]; then
            FIRST_SKILL=$(echo "$SKILLS_LIST" | cut -d',' -f1)
            git commit -m "Add pending plugin: $FIRST_SKILL [submission: $SUBMISSION_ID]"
            PR_TITLE="New plugin: $FIRST_SKILL ($HIGHEST_RISK risk)"
          else
            git commit -m "Add $PROCESSED_COUNT pending plugins from $REPO_NAME [submission: $SUBMISSION_ID]"
            PR_TITLE="New plugins: $PROCESSED_COUNT skills from $REPO_NAME ($HIGHEST_RISK risk)"
          fi
          
          git push origin "$BRANCH_NAME"
          
          # Build risk badge
          RISK_BADGE="ðŸŸ¢"
          [ "$HIGHEST_RISK" = "critical" ] && RISK_BADGE="ðŸ”´"
          [ "$HIGHEST_RISK" = "high" ] && RISK_BADGE="ðŸŸ "
          [ "$HIGHEST_RISK" = "medium" ] && RISK_BADGE="ðŸŸ¡"
          [ "$HIGHEST_RISK" = "low" ] && RISK_BADGE="ðŸŸ¡"
          
          # Build skills table
          SKILLS_TABLE="| Skill | Risk | Status |
          |-------|------|--------|"
          
          for slug in $(echo "$SKILLS_LIST" | tr ',' '\n'); do
            if [ -f "pending/$slug/skill-report.json" ]; then
              SKILL_RISK=$(jq -r '.security_audit.risk_level // "unknown"' "pending/$slug/skill-report.json")
              SKILLS_TABLE="$SKILLS_TABLE
          | \`$slug\` | $SKILL_RISK | Ready |"
            fi
          done
          
          # Create PR body
          cat > pr-body.md << EOF
          ## Skill Submission: $REPO_NAME
          
          **Submission ID**: \`$SUBMISSION_ID\`
          **Source**: $GITHUB_URL
          **Submitter**: $SUBMITTER_EMAIL
          
          ### Summary $RISK_BADGE
          - Skills processed: $PROCESSED_COUNT
          - Highest risk: $HIGHEST_RISK
          
          ### Skills
          $SKILLS_TABLE
          
          ### Review Checklist
          - [ ] All skill contents are appropriate
          - [ ] Security audit findings reviewed
          - [ ] Source repository checked
          
          ---
          *Processed by skillstore-cli v$(./skillstore-cli --version)*
          EOF
          
          gh pr create \
            --title "$PR_TITLE" \
            --body-file pr-body.md \
            --label "pending-review" \
            --base main \
            --head "$BRANCH_NAME"

      - name: Cleanup
        if: always()
        run: |
          rm -f skillstore-cli process-output.log pr-body.md
