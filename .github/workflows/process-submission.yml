name: Process Skill Submission

on:
  repository_dispatch:
    types: [process-submission]
  workflow_dispatch:
    inputs:
      github_url:
        description: 'GitHub URL of the skill to process'
        required: true
        type: string
      submitter_email:
        description: 'Submitter email (optional)'
        required: false
        type: string

env:
  SUBMISSION_ID: ${{ github.event.client_payload.submission_id || github.run_id }}
  GITHUB_URL: ${{ github.event.client_payload.github_url || inputs.github_url }}
  SUBMITTER_EMAIL: ${{ github.event.client_payload.submitter_email || inputs.submitter_email || 'manual@skillstore.io' }}
  SUBMITTER_NOTES: ${{ github.event.client_payload.notes || '' }}
  AI_API_BASE: ${{ vars.AI_API_BASE || 'http://192.168.199.7:3001/v1' }}
  AI_MODEL: ${{ vars.AI_MODEL || 'gpt-5.2:high' }}
  WORK_DIR: /tmp/skill-submission-${{ github.run_id }}

jobs:
  process:
    runs-on: self-hosted
    steps:
      - name: Checkout marketplace
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup work directory
        run: |
          rm -rf "$WORK_DIR"
          mkdir -p "$WORK_DIR"
          echo "Work directory: $WORK_DIR"

      - name: Parse GitHub URL
        id: parse
        run: |
          URL="${{ env.GITHUB_URL }}"
          echo "Parsing URL: $URL"
          
          if [[ $URL =~ github\.com/([^/]+)/([^/]+)(/(tree|blob)/([^/]+)(/(.+))?)? ]]; then
            OWNER="${BASH_REMATCH[1]}"
            REPO="${BASH_REMATCH[2]}"
            BRANCH="${BASH_REMATCH[5]:-main}"
            SKILL_PATH="${BASH_REMATCH[7]:-}"
            
            if [[ "$SKILL_PATH" =~ \.(md|txt|json|yaml|yml)$ ]]; then
              SKILL_PATH=$(dirname "$SKILL_PATH")
            fi
            
            echo "owner=$OWNER" >> $GITHUB_OUTPUT
            echo "repo=$REPO" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "skill_path=$SKILL_PATH" >> $GITHUB_OUTPUT
            
            if [ -n "$SKILL_PATH" ]; then
              SLUG=$(basename "$SKILL_PATH" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
            else
              SLUG=$(echo "$REPO" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
            fi
            echo "slug=$SLUG" >> $GITHUB_OUTPUT
            
            echo "Parsed: owner=$OWNER, repo=$REPO, branch=$BRANCH, path=$SKILL_PATH, slug=$SLUG"
          else
            echo "Failed to parse GitHub URL"
            exit 1
          fi

      - name: Clone source repository
        run: |
          git clone --depth 1 --branch ${{ steps.parse.outputs.branch }} \
            "https://github.com/${{ steps.parse.outputs.owner }}/${{ steps.parse.outputs.repo }}.git" \
            $WORK_DIR/source-repo

      - name: Process all skills
        id: process
        env:
          SKILL_PATH: ${{ steps.parse.outputs.skill_path }}
          SOURCE_URL: ${{ env.GITHUB_URL }}
        run: |
          chmod +x .github/scripts/process-skills.sh
          .github/scripts/process-skills.sh

      - name: Create Pull Request
        if: steps.process.outputs.should_block_all != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SUBMISSION_ID="${{ env.SUBMISSION_ID }}"
          HIGHEST_RISK="${{ steps.process.outputs.highest_risk }}"
          PROCESSED_COUNT="${{ steps.process.outputs.processed_count }}"
          BLOCKED_COUNT="${{ steps.process.outputs.blocked_count }}"
          SKILLS_LIST="${{ steps.process.outputs.skills_list }}"
          SKILL_COUNT="${{ steps.process.outputs.skill_count }}"
          REPO_NAME="${{ steps.parse.outputs.repo }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="submission/${REPO_NAME}-${SUBMISSION_ID}"
          git checkout -b "$BRANCH_NAME"
          git add pending/
          
          if [ "$PROCESSED_COUNT" -eq 1 ]; then
            FIRST_SKILL=$(echo "$SKILLS_LIST" | cut -d',' -f1)
            git commit -m "Add pending plugin: $FIRST_SKILL [submission: $SUBMISSION_ID]"
            PR_TITLE="New plugin: $FIRST_SKILL ($HIGHEST_RISK risk)"
          else
            git commit -m "Add $PROCESSED_COUNT pending plugins from $REPO_NAME [submission: $SUBMISSION_ID]"
            PR_TITLE="New plugins: $PROCESSED_COUNT skills from $REPO_NAME ($HIGHEST_RISK risk)"
          fi
          
          git push origin "$BRANCH_NAME"
          
          RISK_BADGE="ðŸŸ¢"
          [ "$HIGHEST_RISK" = "critical" ] && RISK_BADGE="ðŸ”´"
          [ "$HIGHEST_RISK" = "high" ] && RISK_BADGE="ðŸŸ "
          [ "$HIGHEST_RISK" = "medium" ] && RISK_BADGE="ðŸŸ¡"
          
          SKILLS_TABLE="| Skill | Risk | Status |
          |-------|------|--------|"
          
          for slug in $(echo "$SKILLS_LIST" | tr ',' '\n'); do
            if [ -f "pending/$slug/skill-report.json" ]; then
              SKILL_RISK=$(jq -r '.security_audit.risk_level // "unknown"' "pending/$slug/skill-report.json")
              SKILLS_TABLE="$SKILLS_TABLE
          | \`$slug\` | $SKILL_RISK | Ready |"
            fi
          done
          
          PR_BODY="## Skill Submission: $REPO_NAME
          
          **Submission ID**: \`$SUBMISSION_ID\`
          **Source**: ${{ env.GITHUB_URL }}
          **Submitter**: ${{ env.SUBMITTER_EMAIL }}
          
          ### Summary $RISK_BADGE
          - Skills discovered: $SKILL_COUNT
          - Skills ready: $PROCESSED_COUNT
          - Skills blocked: $BLOCKED_COUNT
          
          ### Skills
          $SKILLS_TABLE
          
          ### Review Checklist
          - [ ] All skill contents are appropriate
          - [ ] Security audit findings reviewed
          - [ ] Source repository checked
          
          ---
          *Automated via skillstore.io | AI Model: $AI_MODEL*"
          
          echo "$PR_BODY" > $WORK_DIR/pr-body.md
          
          gh pr create \
            --title "$PR_TITLE" \
            --body-file $WORK_DIR/pr-body.md \
            --label "pending-review" \
            --base main \
            --head "$BRANCH_NAME"

      - name: Handle all blocked
        if: steps.process.outputs.should_block_all == 'true'
        run: |
          echo "::error::All skills blocked due to security concerns"
          echo "Blocked skills: $(cat $WORK_DIR/blocked-skills.txt 2>/dev/null)"
          exit 1
