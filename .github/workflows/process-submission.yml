name: Process Skill Submission

on:
  repository_dispatch:
    types: [process-submission]
  workflow_dispatch:
    inputs:
      github_url:
        description: 'GitHub URL of the skill to process'
        required: true
        type: string
      model:
        description: 'Model to use (e.g., gpt-5.2-codex:high, claude-sonnet-4.5). Auto-detects agent.'
        required: false
        type: string
        default: ''
      submitter_email:
        description: 'Submitter email (optional)'
        required: false
        type: string
      cli_version:
        description: 'CLI version (default: latest)'
        required: false
        type: string
        default: 'latest'
      limit:
        description: 'Max skills to process (for testing)'
        required: false
        type: string
        default: ''

env:
  SUBMISSION_ID: ${{ github.event.client_payload.submission_id || github.run_id }}
  GITHUB_URL: ${{ github.event.client_payload.github_url || inputs.github_url }}
  SUBMITTER_EMAIL: ${{ github.event.client_payload.submitter_email || inputs.submitter_email || 'manual@skillstore.io' }}
  CLI_VERSION: ${{ inputs.cli_version || 'latest' }}

jobs:
  process:
    runs-on: self-hosted
    steps:
      - name: Checkout marketplace
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Notify skillstore - Processing started
        if: github.event_name == 'repository_dispatch'
        run: |
          curl -sS -X POST "${{ secrets.SKILLSTORE_API_URL }}/api/submit/callback" \
            -H "Authorization: Bearer ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "submission_id": "'"$SUBMISSION_ID"'",
              "event": "started",
              "workflow_run_id": ${{ github.run_id }},
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "::warning::Failed to notify skillstore"

      - name: Download Skillstore CLI
        uses: ./.github/actions/download-skillstore-cli
        with:
          version: ${{ inputs.cli_version || 'latest' }}
          token: ${{ secrets.PAT_TOKEN }}

      - name: Process submission
        id: process
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKILLSTORE_AGENTS: ${{ secrets.SKILLSTORE_AGENTS }}
          PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "Processing: $GITHUB_URL"
          echo "Submission ID: $SUBMISSION_ID"
          
          # Run CLI with output captured
          # CLI creates pending/{slug}/ structure, so output to current dir
          MODEL_FLAG=""
          if [ -n "${{ inputs.model }}" ]; then
            MODEL_FLAG="--model ${{ inputs.model }}"
          fi
          
          LIMIT_FLAG=""
          if [ -n "${{ inputs.limit }}" ]; then
            LIMIT_FLAG="--limit ${{ inputs.limit }}"
          fi
          
          ./skillstore-cli skill process "$GITHUB_URL" \
            --output . \
            --marketplace-repo "${{ github.repository }}" \
            $MODEL_FLAG \
            $LIMIT_FLAG \
            --verbose \
            2>&1 | tee process-output.log
          
          # Extract results from CLI output (it outputs structured info)
          # The CLI handles cloning, discovery, analysis, and packaging
          
          SKILL_REPORTS=$(find pending -name "skill-report.json" 2>/dev/null)
          
          if [ -n "$SKILL_REPORTS" ]; then
            PROCESSED_SKILLS=""
            PROCESSED_COUNT=0
            HIGHEST_RISK="safe"
            
            for report in $SKILL_REPORTS; do
              NAMESPACED_SLUG=$(jq -r '.meta.owner + "/" + .meta.slug' "$report")
              SOURCE_TYPE=$(jq -r '.meta.source_type' "$report")
              
              if [ "$SOURCE_TYPE" = "official" ]; then
                NAMESPACED_SLUG=$(jq -r '.meta.slug' "$report")
              fi
              
              PROCESSED_SKILLS="$PROCESSED_SKILLS,$NAMESPACED_SLUG"
              PROCESSED_COUNT=$((PROCESSED_COUNT + 1))
              
              RISK=$(jq -r '.security_audit.risk_level // "unknown"' "$report")
              case "$RISK" in
                critical) HIGHEST_RISK="critical" ;;
                high) [ "$HIGHEST_RISK" != "critical" ] && HIGHEST_RISK="high" ;;
                medium) [ "$HIGHEST_RISK" = "safe" ] || [ "$HIGHEST_RISK" = "low" ] && HIGHEST_RISK="medium" ;;
                low) [ "$HIGHEST_RISK" = "safe" ] && HIGHEST_RISK="low" ;;
              esac
            done
            
            PROCESSED_SKILLS=$(echo "$PROCESSED_SKILLS" | sed 's/^,//')
            
            echo "processed_count=$PROCESSED_COUNT" >> $GITHUB_OUTPUT
            echo "skills_list=$PROCESSED_SKILLS" >> $GITHUB_OUTPUT
            echo "has_results=true" >> $GITHUB_OUTPUT
            echo "highest_risk=$HIGHEST_RISK" >> $GITHUB_OUTPUT
            
            echo "Processed $PROCESSED_COUNT skill(s): $PROCESSED_SKILLS"
            echo "Highest risk: $HIGHEST_RISK"
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
            echo "::error::No skills processed"
            exit 1
          fi

      - name: Create Pull Request
        id: create_pr
        if: steps.process.outputs.has_results == 'true'
        env:
          # Use PAT_TOKEN instead of GITHUB_TOKEN so the PR can trigger other workflows
          # GITHUB_TOKEN-created PRs don't trigger workflows (GitHub security feature)
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          PROCESSED_COUNT="${{ steps.process.outputs.processed_count }}"
          SKILLS_LIST="${{ steps.process.outputs.skills_list }}"
          HIGHEST_RISK="${{ steps.process.outputs.highest_risk }}"
          
          # Extract repo name from URL
          REPO_NAME=$(echo "$GITHUB_URL" | sed -E 's|.*/([^/]+)/?$|\1|' | sed 's/\.git$//')
          
          BRANCH_NAME="submission/${REPO_NAME}-${SUBMISSION_ID}"
          
          # Delete remote branch if it exists (from previous failed run)
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
          
          git checkout -b "$BRANCH_NAME"
          git add pending/
          
          if [ "$PROCESSED_COUNT" -eq 1 ]; then
            FIRST_SKILL=$(echo "$SKILLS_LIST" | cut -d',' -f1)
            git commit -m "Add pending plugin: $FIRST_SKILL [submission: $SUBMISSION_ID]"
            PR_TITLE="New plugin: $FIRST_SKILL ($HIGHEST_RISK risk)"
          else
            git commit -m "Add $PROCESSED_COUNT pending plugins from $REPO_NAME [submission: $SUBMISSION_ID]"
            PR_TITLE="New plugins: $PROCESSED_COUNT skills from $REPO_NAME ($HIGHEST_RISK risk)"
          fi
          
          git push origin "$BRANCH_NAME"
          
          # Build risk badge
          RISK_BADGE="ðŸŸ¢"
          [ "$HIGHEST_RISK" = "critical" ] && RISK_BADGE="ðŸ”´"
          [ "$HIGHEST_RISK" = "high" ] && RISK_BADGE="ðŸŸ "
          [ "$HIGHEST_RISK" = "medium" ] && RISK_BADGE="ðŸŸ¡"
          [ "$HIGHEST_RISK" = "low" ] && RISK_BADGE="ðŸŸ¡"
          
          SKILLS_TABLE="| Skill | Risk | Status |
          |-------|------|--------|"
          
          for report in $(find pending -name "skill-report.json" 2>/dev/null); do
            NAMESPACED_SLUG=$(jq -r 'if .meta.source_type == "official" then .meta.slug else .meta.owner + "/" + .meta.slug end' "$report")
            SKILL_RISK=$(jq -r '.security_audit.risk_level // "unknown"' "$report")
            SKILLS_TABLE="$SKILLS_TABLE
          | \`$NAMESPACED_SLUG\` | $SKILL_RISK | Ready |"
          done
          
          # Create PR body
          cat > pr-body.md << EOF
          ## Skill Submission: $REPO_NAME
          
          **Submission ID**: \`$SUBMISSION_ID\`
          **Source**: $GITHUB_URL
          **Submitter**: $SUBMITTER_EMAIL
          
          ### Summary $RISK_BADGE
          - Skills processed: $PROCESSED_COUNT
          - Highest risk: $HIGHEST_RISK
          
          ### Skills
          $SKILLS_TABLE
          
          ### Review Checklist
          - [ ] All skill contents are appropriate
          - [ ] Security audit findings reviewed
          - [ ] Source repository checked
          
          ---
          *Processed by skillstore-cli v$(./skillstore-cli --version)*
          EOF
          
          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body-file pr-body.md \
            --label "pending-review" \
            --base main \
            --head "$BRANCH_NAME" 2>&1 | tail -1)
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"

      - name: Notify skillstore - PR created
        if: steps.create_pr.outputs.pr_url && github.event_name == 'repository_dispatch'
        env:
          PR_URL: ${{ steps.create_pr.outputs.pr_url }}
        run: |
          curl -sS -X POST "${{ secrets.SKILLSTORE_API_URL }}/api/submit/callback" \
            -H "Authorization: Bearer ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "submission_id": "'"$SUBMISSION_ID"'",
              "event": "pr_created",
              "pr_url": "'"$PR_URL"'",
              "workflow_run_id": ${{ github.run_id }},
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "::warning::Failed to notify skillstore"

      - name: Notify skillstore - Failed
        if: failure() && github.event_name == 'repository_dispatch'
        run: |
          ERROR_MSG="Processing failed. Check GitHub Actions log for details."
          if [ -f process-output.log ]; then
            ERROR_MSG=$(tail -5 process-output.log | tr '\n' ' ' | cut -c1-500)
          fi
          
          curl -sS -X POST "${{ secrets.SKILLSTORE_API_URL }}/api/submit/callback" \
            -H "Authorization: Bearer ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "submission_id": "'"$SUBMISSION_ID"'",
              "event": "failed",
              "error_message": "'"${ERROR_MSG//\"/\\\"}"'",
              "workflow_run_id": ${{ github.run_id }},
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "::warning::Failed to notify skillstore"

      - name: Cleanup
        if: always()
        run: |
          rm -f skillstore-cli process-output.log pr-body.md
