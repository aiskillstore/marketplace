# Process Skill Submission - Parallel Processing Workflow
#
# Architecture:
#   - Uses reusable-process-skills.yml for core processing logic
#   - Handles both repository_dispatch and workflow_dispatch triggers
#   - Sends notifications to skillstore API on completion
#
# Dynamic Sharding:
#   - < 30 skills: Single job (simple mode)
#   - >= 30 skills: Split evenly across 6 parallel shards
#
# Retry Logic:
#   - Each shard retries failed skills once before giving up

name: Process Skill Submission

on:
  repository_dispatch:
    types: [process-submission]
  workflow_dispatch:
    inputs:
      github_url:
        description: 'GitHub URL of the skill to process'
        required: true
        type: string
      model:
        description: 'Model to use (e.g., gpt-5.2-codex:high, claude-sonnet-4.5). Auto-detects agent.'
        required: false
        type: string
        default: ''
      cli_version:
        description: 'CLI version (default: latest)'
        required: false
        type: string
        default: 'latest'
      max_parallel:
        description: 'Max parallel shards (default: 6)'
        type: string
        default: '6'

env:
  SUBMISSION_ID: ${{ github.event.client_payload.submission_id || github.run_id }}
  GITHUB_URL: ${{ github.event.client_payload.github_url || inputs.github_url }}

concurrency:
  group: process-submission-${{ github.event.client_payload.submission_id || github.run_id }}
  cancel-in-progress: false

jobs:
  # ============================================================
  # JOB 1: PROCESS SKILLS (Reusable Workflow)
  # Discovers, processes, and creates PR for submission
  # ============================================================
  process-skills:
    uses: ./.github/workflows/reusable-process-skills.yml
    with:
      github_url: ${{ github.event.client_payload.github_url || inputs.github_url }}
      submission_id: ${{ github.event.client_payload.submission_id || github.run_id }}
      model: ${{ inputs.model || '' }}
      cli_version: ${{ inputs.cli_version || 'latest' }}
      max_parallel: ${{ inputs.max_parallel || '6' }}
      is_manual_approval: false
      approved_by: ''
    secrets:
      APP_ID: ${{ secrets.APP_ID }}
      APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SKILLSTORE_AGENTS: ${{ vars.SKILLSTORE_AGENTS }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      SKILLSTORE_API_URL: ${{ secrets.SKILLSTORE_API_URL }}
      SKILLSTORE_CALLBACK_TOKEN: ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}

  # ============================================================
  # JOB 2: NOTIFICATIONS AND SUMMARY
  # Sends callbacks to skillstore API and creates workflow summary
  # ============================================================
  notify:
    needs: process-skills
    if: always() && github.event_name == 'repository_dispatch'
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Notify skillstore - PR created
        if: needs.process-skills.outputs.pr_url
        env:
          PR_URL: ${{ needs.process-skills.outputs.pr_url }}
          PROCESSED_COUNT: ${{ needs.process-skills.outputs.processed_count }}
          SKILLSTORE_API_URL: ${{ secrets.SKILLSTORE_API_URL }}
          SKILLSTORE_CALLBACK_TOKEN: ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}
        run: |
          # Validate PR URL before sending callback
          if [[ ! "$PR_URL" =~ ^https://github.com/.*/pull/[0-9]+$ ]]; then
            echo "::warning::Invalid PR URL format: $PR_URL"
            exit 0
          fi

          echo "ðŸ“¤ Notifying skillstore: PR created at $PR_URL"
          curl -sS -X POST "$SKILLSTORE_API_URL/api/submit/callback" \
            -H "Authorization: Bearer $SKILLSTORE_CALLBACK_TOKEN" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/SkillstoreBot" \
            -H "X-Skillstore-Callback: true" \
            -d '{
              "submission_id": "'"${{ env.SUBMISSION_ID }}"'",
              "event": "pr_created",
              "pr_url": "'"$PR_URL"'",
              "processed_count": '"$PROCESSED_COUNT"',
              "workflow_run_id": ${{ github.run_id }},
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "::warning::Failed to notify skillstore"

      - name: Notify skillstore - Failed
        if: needs.process-skills.result == 'failure'
        run: |
          curl -sS -X POST "${{ secrets.SKILLSTORE_API_URL }}/api/submit/callback" \
            -H "Authorization: Bearer ${{ secrets.SKILLSTORE_CALLBACK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/SkillstoreBot" \
            -H "X-Skillstore-Callback: true" \
            -d '{
              "submission_id": "'"${{ env.SUBMISSION_ID }}"'",
              "event": "failed",
              "error_message": "Processing failed. Check GitHub Actions log for details.",
              "workflow_run_id": ${{ github.run_id }},
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "::warning::Failed to notify skillstore"

      - name: Summary
        if: always()
        env:
          PR_URL: ${{ needs.process-skills.outputs.pr_url }}
          PROCESSED_COUNT: ${{ needs.process-skills.outputs.processed_count }}
          HIGHEST_RISK: ${{ needs.process-skills.outputs.highest_risk }}
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Processing Summary

          **Source**: ${{ env.GITHUB_URL }}
          **Submission ID**: \`${{ env.SUBMISSION_ID }}\`

          | Metric | Value |
          |--------|-------|
          | Workflow Status | ${{ needs.process-skills.result }} |
          | Successfully Processed | ${PROCESSED_COUNT:-N/A} |
          | Highest Risk | ${HIGHEST_RISK:-N/A} |

          EOF

          if [ -n "$PR_URL" ]; then
            echo "ðŸ”— **PR Created**: $PR_URL" >> $GITHUB_STEP_SUMMARY
          fi
