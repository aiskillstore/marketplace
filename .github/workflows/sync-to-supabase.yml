name: Sync to Supabase (Incremental)

on:
  push:
    branches: [main]
    paths:
      - 'plugins/**'
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Force full sync (ignore incremental)'
        type: boolean
        default: false

jobs:
  sync:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @supabase/supabase-js

      - name: Detect changed plugins
        id: changes
        run: |
          if [ "${{ inputs.full_sync }}" = "true" ]; then
            echo "Full sync requested"
            CHANGED=$(ls -1 plugins/ 2>/dev/null | tr '\n' ' ')
            echo "mode=full" >> $GITHUB_OUTPUT
          else
            CHANGED=$(git diff HEAD~1 --name-only 2>/dev/null | \
              grep '^plugins/' | \
              cut -d'/' -f2 | \
              sort -u | \
              tr '\n' ' ')
            echo "mode=incremental" >> $GITHUB_OUTPUT
          fi
          
          echo "changed_plugins=$CHANGED" >> $GITHUB_OUTPUT
          
          if [ -z "$CHANGED" ]; then
            echo "No plugins to sync"
            echo "skip_sync=true" >> $GITHUB_OUTPUT
          else
            echo "Plugins to sync: $CHANGED"
            echo "skip_sync=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync plugins to Supabase
        if: steps.changes.outputs.skip_sync != 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          CHANGED_PLUGINS: ${{ steps.changes.outputs.changed_plugins }}
          SYNC_MODE: ${{ steps.changes.outputs.mode }}
        run: |
          node << 'EOF'
          const { createClient } = require('@supabase/supabase-js');
          const fs = require('fs');
          const path = require('path');

          const supabase = createClient(
            process.env.SUPABASE_URL,
            process.env.SUPABASE_SERVICE_KEY
          );

          async function syncPlugins() {
            const changedPlugins = process.env.CHANGED_PLUGINS.trim().split(/\s+/).filter(Boolean);
            const mode = process.env.SYNC_MODE;
            
            console.log(`Sync mode: ${mode}`);
            console.log(`Syncing ${changedPlugins.length} plugin(s): ${changedPlugins.join(', ')}`);

            let synced = 0;
            let errors = 0;

            for (const slug of changedPlugins) {
              const pluginPath = `plugins/${slug}`;
              const reportPath = path.join(pluginPath, 'skill-report.json');
              const manifestPath = path.join(pluginPath, '.claude-plugin', 'plugin.json');
              const entryPath = path.join(pluginPath, 'marketplace-entry.json');

              if (!fs.existsSync(pluginPath)) {
                console.log(`Skipping ${slug}: directory not found`);
                continue;
              }

              let skillReport = null;
              let manifest = null;
              let entry = null;

              if (fs.existsSync(reportPath)) {
                skillReport = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              }
              if (fs.existsSync(manifestPath)) {
                manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              }
              if (fs.existsSync(entryPath)) {
                entry = JSON.parse(fs.readFileSync(entryPath, 'utf8'));
              }

              const record = {
                slug: slug,
                name: skillReport?.content?.user_title || entry?.name || slug,
                canonical_name: slug,
                description: entry?.description || skillReport?.content?.value_statement,
                version: entry?.version || '1.0.0',
                author_name: entry?.author?.name || 'Community',
                
                marketplace_source: 'aiskillstore',
                plugin_path: pluginPath,
                
                security_risk_level: skillReport?.security_audit?.risk_level || null,
                security_safe_to_publish: skillReport?.security_audit?.safe_to_publish ?? true,
                security_summary: skillReport?.security_audit?.summary || null,
                
                user_title: skillReport?.content?.user_title || null,
                value_statement: skillReport?.content?.value_statement || null,
                seo_keywords: skillReport?.content?.seo_keywords || [],
                
                source_url: skillReport?.meta?.source_url || entry?.repository || null,
                source_ref: skillReport?.meta?.source_ref || null,
                
                status: 'published',
                published_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
              };

              const { error } = await supabase
                .schema('skillstore')
                .from('skills')
                .upsert(record, { onConflict: 'slug' });

              if (error) {
                console.error(`Error: ${slug} - ${error.message}`);
                errors++;
              } else {
                console.log(`âœ… Synced: ${slug}`);
                synced++;
              }
            }

            console.log(`\nSync complete: ${synced} synced, ${errors} errors`);
          }

          syncPlugins().catch(err => {
            console.error('Sync failed:', err);
            process.exit(1);
          });
          EOF

      - name: Report sync status
        run: |
          echo "::notice::Sync completed - Mode: ${{ steps.changes.outputs.mode }}, Plugins: ${{ steps.changes.outputs.changed_plugins }}"
