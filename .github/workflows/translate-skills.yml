# GitHub Action Workflow for Marketplace Repository
# Auto-sharding: switches to batch mode when skill count exceeds threshold
#
# IMPORTANT: This workflow is triggered BY sync-to-supabase.yml after data sync completes.
# This ensures translation reads fresh data from the database, avoiding race conditions.

name: Auto-Translate Skill Content

on:
  # Triggered by sync-to-supabase.yml after sync completes (avoids race condition)
  workflow_call:
    inputs:
      plugin_slugs:
        description: "Plugins to translate, comma-separated"
        type: string
        required: true
      model:
        description: "Model to use"
        type: string
        default: ""
      force:
        description: "Force re-translation"
        type: boolean
        default: false
      concurrency:
        description: "Parallel translations per skill"
        type: string
        default: "3"
      shard_size:
        description: "Skills per shard"
        type: string
        default: "30"
      max_parallel:
        description: "Max parallel shards"
        type: string
        default: "4"
      cli_version:
        description: "CLI version"
        type: string
        default: "latest"
    secrets:
      SUPABASE_URL:
        required: true
      SUPABASE_SERVICE_KEY:
        required: true
      SKILLSTORE_AGENTS:
        required: true
      PAT_TOKEN:
        required: true
      CACHE_INVALIDATE_SECRET:
        required: true
  # Manual trigger for ad-hoc translations
  workflow_dispatch:
    inputs:
      plugin_slugs:
        description: "Specific plugins to translate, comma-separated (e.g., owner-repo1,owner-repo2)"
        required: false
      model:
        description: "Model to use (e.g., gpt-5.2-codex:high, claude-sonnet-4.5). Auto-detects agent."
        type: string
        default: ""
      force:
        description: "Force re-translation of existing translations"
        type: boolean
        default: false
      concurrency:
        description: "Parallel language translations per skill (1-10)"
        type: string
        default: "3"
      shard_size:
        description: "Skills per shard when auto-sharding (default: 30)"
        type: string
        default: "30"
      max_parallel:
        description: "Max parallel shards (default: 4)"
        type: string
        default: "4"
      cli_version:
        description: "CLI version (default: latest)"
        required: false
        type: string
        default: "latest"

env:
  CLI_VERSION: ${{ inputs.cli_version || 'latest' }}
  SHARD_THRESHOLD: 30

concurrency:
  group: translate-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-and-plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix }}
      slugs_csv: ${{ steps.detect.outputs.slugs_csv }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      skill_count: ${{ steps.detect.outputs.skill_count }}
      translate_all: ${{ steps.detect.outputs.translate_all }}
      is_sharded: ${{ steps.plan.outputs.is_sharded }}
      shard_count: ${{ steps.plan.outputs.shard_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect plugins to translate
        id: detect
        run: |
          # Get slugs from input (workflow_call or workflow_dispatch)
          SLUGS_CSV="${{ inputs.plugin_slugs }}"
          
          if [ -n "$SLUGS_CSV" ]; then
            SKILL_COUNT=$(echo "$SLUGS_CSV" | tr ',' '\n' | grep -c . || echo 0)
            echo "slugs_csv=$SLUGS_CSV" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "skill_count=$SKILL_COUNT" >> $GITHUB_OUTPUT
            echo "translate_all=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Translating $SKILL_COUNT skill(s): $SLUGS_CSV"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ðŸŒ Manual trigger without slugs - will translate ALL approved skills from database"
            echo "slugs_csv=" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "skill_count=all" >> $GITHUB_OUTPUT
            echo "translate_all=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No slugs provided and not a manual trigger"
            echo "slugs_csv=" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "skill_count=0" >> $GITHUB_OUTPUT
            echo "translate_all=false" >> $GITHUB_OUTPUT
          fi

      - name: Plan translation strategy
        id: plan
        env:
          SKILL_COUNT: ${{ steps.detect.outputs.skill_count }}
          TRANSLATE_ALL: ${{ steps.detect.outputs.translate_all }}
          SLUGS_CSV: ${{ steps.detect.outputs.slugs_csv }}
          SHARD_SIZE: ${{ inputs.shard_size || '30' }}
        run: |
          # Determine if sharding is needed
          if [ "$TRANSLATE_ALL" = "true" ]; then
            # For translate_all, always use sharded mode (assume large count)
            # CLI will query database and handle batching internally
            echo "ðŸŒ Translate ALL mode - using sharded approach"
            echo 'matrix={"include":[{"shard":0,"slugs":"","is_all":"true"}]}' >> $GITHUB_OUTPUT
            echo "is_sharded=false" >> $GITHUB_OUTPUT
            echo "shard_count=1" >> $GITHUB_OUTPUT
            exit 0
          fi

          COUNT=$SKILL_COUNT
          if [ "$COUNT" = "0" ] || [ -z "$COUNT" ]; then
            echo "No skills to translate"
            echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
            echo "is_sharded=false" >> $GITHUB_OUTPUT
            echo "shard_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          THRESHOLD=${{ env.SHARD_THRESHOLD }}
          
          if [ "$COUNT" -lt "$THRESHOLD" ]; then
            # Simple mode: single shard with all slugs
            echo "ðŸ“¦ Simple mode: $COUNT skills (below threshold $THRESHOLD)"
            # Escape the slugs for JSON
            ESCAPED_SLUGS=$(echo "$SLUGS_CSV" | sed 's/"/\\"/g')
            echo "matrix={\"include\":[{\"shard\":0,\"slugs\":\"$ESCAPED_SLUGS\",\"is_all\":\"false\"}]}" >> $GITHUB_OUTPUT
            echo "is_sharded=false" >> $GITHUB_OUTPUT
            echo "shard_count=1" >> $GITHUB_OUTPUT
          else
            # Sharded mode: split slugs into batches
            echo "ðŸ”€ Sharded mode: $COUNT skills (>= threshold $THRESHOLD)"
            
            SIZE=$SHARD_SIZE
            SHARDS=$(( (COUNT + SIZE - 1) / SIZE ))
            echo "Shard size: $SIZE, Shards needed: $SHARDS"
            
            # Convert CSV to array
            IFS=',' read -ra SLUG_ARRAY <<< "$SLUGS_CSV"
            
            MATRIX='{"include":['
            for i in $(seq 0 $((SHARDS - 1))); do
              START=$((i * SIZE))
              END=$((START + SIZE))
              [ $END -gt $COUNT ] && END=$COUNT
              
              # Extract slugs for this shard
              SHARD_SLUGS=""
              for j in $(seq $START $((END - 1))); do
                [ -n "$SHARD_SLUGS" ] && SHARD_SLUGS="$SHARD_SLUGS,"
                SHARD_SLUGS="$SHARD_SLUGS${SLUG_ARRAY[$j]}"
              done
              
              [ $i -gt 0 ] && MATRIX+=','
              ESCAPED_SHARD_SLUGS=$(echo "$SHARD_SLUGS" | sed 's/"/\\"/g')
              MATRIX+="{\"shard\":$i,\"slugs\":\"$ESCAPED_SHARD_SLUGS\",\"is_all\":\"false\"}"
              
              echo "Shard $i: skills $START-$((END-1)) ($((END - START)) skills)"
            done
            MATRIX+=']}'
            
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
            echo "is_sharded=true" >> $GITHUB_OUTPUT
            echo "shard_count=$SHARDS" >> $GITHUB_OUTPUT
          fi

  translate:
    needs: detect-and-plan
    if: needs.detect-and-plan.outputs.has_changes == 'true' && needs.detect-and-plan.outputs.shard_count != '0'
    runs-on: self-hosted
    environment: production
    timeout-minutes: 120
    continue-on-error: true
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJSON(inputs.max_parallel || '4') }}
      matrix: ${{ fromJSON(needs.detect-and-plan.outputs.matrix) }}
    outputs:
      shard_count: ${{ needs.detect-and-plan.outputs.shard_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/actions

      - name: Download Skillstore CLI
        uses: ./.github/actions/download-skillstore-cli
        with:
          version: ${{ inputs.cli_version || 'latest' }}
          token: ${{ secrets.PAT_TOKEN }}

      - name: Translate shard ${{ matrix.shard }}
        id: translate
        timeout-minutes: 90
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SKILLSTORE_AGENTS: ${{ secrets.SKILLSTORE_AGENTS }}
          SLUGS: ${{ matrix.slugs }}
          IS_ALL: ${{ matrix.is_all }}
          CONCURRENCY: ${{ inputs.concurrency || '3' }}
        run: |
          echo "=== Shard ${{ matrix.shard }} ==="
          
          if [ "$IS_ALL" = "true" ]; then
            echo "ðŸŒ Translating ALL approved skills"
            SLUGS_FLAG=""
          else
            SKILL_COUNT=$(echo "$SLUGS" | tr ',' '\n' | grep -c . || echo 0)
            echo "ðŸš€ Translating $SKILL_COUNT skill(s)"
            echo "Skills: $SLUGS"
            SLUGS_FLAG="--slugs $SLUGS"
          fi

          MODEL_FLAG=""
          if [ -n "${{ inputs.model }}" ]; then
            MODEL_FLAG="--model ${{ inputs.model }}"
          fi

          FORCE_FLAG=""
          if [ "${{ inputs.force }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi

          # Run CLI: stdout=JSON, stderr=progress logs (visible in Actions log)
          set +e
          RESULT=$(./skillstore-cli skill translate-content \
            $SLUGS_FLAG \
            --concurrency "$CONCURRENCY" \
            --output json \
            $MODEL_FLAG \
            $FORCE_FLAG)
          EXIT_CODE=$?
          set -e

          # Save result to file for artifact upload
          echo "$RESULT" > shard-${{ matrix.shard }}-result.json

          if echo "$RESULT" | jq -e '.totalSkills' > /dev/null 2>&1; then
            TRANSLATED=$(echo "$RESULT" | jq -r '.translated')
            SKIPPED=$(echo "$RESULT" | jq -r '.skipped')
            ERRORS=$(echo "$RESULT" | jq -r '.errors')
            DURATION=$(echo "$RESULT" | jq -r '.durationMs')
            DURATION_SEC=$((DURATION / 1000))

            echo "ðŸ“Š Shard ${{ matrix.shard }}: $TRANSLATED translated, $SKIPPED skipped, $ERRORS errors (${DURATION_SEC}s)"

            # Create summary file
            echo "$RESULT" | jq -c '{
              shard: ${{ matrix.shard }},
              totalSkills: .totalSkills,
              translated: .translated,
              skipped: .skipped,
              errors: .errors,
              durationMs: .durationMs,
              modelUsed: .modelUsed
            }' > shard-${{ matrix.shard }}-summary.json

            if [ "$ERRORS" -gt 0 ] && [ "$TRANSLATED" -eq 0 ]; then
              echo "âŒ All translations in shard failed"
              exit 1
            elif [ "$ERRORS" -gt 0 ]; then
              echo "âš ï¸ Some translations failed, but continuing"
            else
              echo "âœ… Shard ${{ matrix.shard }} completed successfully"
            fi
          else
            echo "âŒ Translation failed with unexpected output"
            echo "$RESULT"
            # Create error summary
            echo '{"shard":${{ matrix.shard }},"error":"unexpected_output","translated":0,"skipped":0,"errors":1}' > shard-${{ matrix.shard }}-summary.json
            exit 1
          fi

      - name: Upload shard results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translate-shard-${{ matrix.shard }}
          path: |
            shard-${{ matrix.shard }}-summary.json
            shard-${{ matrix.shard }}-result.json
          retention-days: 1

      - name: Cleanup
        if: always()
        run: rm -f skillstore-cli shard-*.json

  merge-results:
    needs: [detect-and-plan, translate]
    if: always() && needs.detect-and-plan.outputs.has_changes == 'true' && needs.detect-and-plan.outputs.shard_count != '0'
    runs-on: ubuntu-latest
    outputs:
      total_translated: ${{ steps.merge.outputs.total_translated }}
      total_skipped: ${{ steps.merge.outputs.total_skipped }}
      total_errors: ${{ steps.merge.outputs.total_errors }}
      total_duration: ${{ steps.merge.outputs.total_duration }}
      result_json: ${{ steps.merge.outputs.result_json }}
    steps:
      - name: Download all shard results
        uses: actions/download-artifact@v4
        with:
          pattern: translate-shard-*
          merge-multiple: true
          path: ./results

      - name: Merge shard results
        id: merge
        run: |
          echo "=== Merging results from all shards ==="
          
          TOTAL_TRANSLATED=0
          TOTAL_SKIPPED=0
          TOTAL_ERRORS=0
          TOTAL_DURATION=0
          SHARD_COUNT=0
          MODEL_USED=""
          
          for summary in ./results/shard-*-summary.json; do
            if [ -f "$summary" ]; then
              SHARD_COUNT=$((SHARD_COUNT + 1))
              
              TRANSLATED=$(jq -r '.translated // 0' "$summary")
              SKIPPED=$(jq -r '.skipped // 0' "$summary")
              ERRORS=$(jq -r '.errors // 0' "$summary")
              DURATION=$(jq -r '.durationMs // 0' "$summary")
              MODEL=$(jq -r '.modelUsed // ""' "$summary")
              
              TOTAL_TRANSLATED=$((TOTAL_TRANSLATED + TRANSLATED))
              TOTAL_SKIPPED=$((TOTAL_SKIPPED + SKIPPED))
              TOTAL_ERRORS=$((TOTAL_ERRORS + ERRORS))
              TOTAL_DURATION=$((TOTAL_DURATION + DURATION))
              
              [ -z "$MODEL_USED" ] && MODEL_USED="$MODEL"
              
              echo "Shard $(jq -r '.shard' "$summary"): $TRANSLATED translated, $SKIPPED skipped, $ERRORS errors"
            fi
          done
          
          TOTAL_SKILLS=$((TOTAL_TRANSLATED + TOTAL_SKIPPED + TOTAL_ERRORS))
          
          echo ""
          echo "ðŸ“Š Combined Results:"
          echo "  Shards processed: $SHARD_COUNT"
          echo "  Total skills: $TOTAL_SKILLS"
          echo "  Translated: $TOTAL_TRANSLATED"
          echo "  Skipped: $TOTAL_SKIPPED"
          echo "  Errors: $TOTAL_ERRORS"
          echo "  Total duration: $((TOTAL_DURATION / 1000))s"
          
          echo "total_translated=$TOTAL_TRANSLATED" >> $GITHUB_OUTPUT
          echo "total_skipped=$TOTAL_SKIPPED" >> $GITHUB_OUTPUT
          echo "total_errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
          echo "total_duration=$TOTAL_DURATION" >> $GITHUB_OUTPUT
          
          # Create combined result JSON (compact for GITHUB_OUTPUT compatibility)
          RESULT_JSON=$(jq -cn \
            --argjson translated "$TOTAL_TRANSLATED" \
            --argjson skipped "$TOTAL_SKIPPED" \
            --argjson errors "$TOTAL_ERRORS" \
            --argjson duration "$TOTAL_DURATION" \
            --argjson shards "$SHARD_COUNT" \
            --arg model "$MODEL_USED" \
            '{
              totalSkills: ($translated + $skipped + $errors),
              translated: $translated,
              skipped: $skipped,
              errors: $errors,
              durationMs: $duration,
              shardCount: $shards,
              modelUsed: $model
            }')
          
          echo "result_json=$RESULT_JSON" >> $GITHUB_OUTPUT

  invalidate-cache:
    needs: [detect-and-plan, translate, merge-results]
    if: always() && needs.translate.result == 'success'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/actions

      - name: Invalidate cache for translated skills
        uses: ./.github/actions/invalidate-cache
        with:
          type: skills
          slugs: ${{ needs.detect-and-plan.outputs.slugs_csv }}
          secret: ${{ secrets.CACHE_INVALIDATE_SECRET }}

  notify:
    needs: [detect-and-plan, translate, merge-results, invalidate-cache]
    if: always() && needs.detect-and-plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        env:
          RESULT_JSON: ${{ needs.merge-results.outputs.result_json }}
          SKILL_COUNT: ${{ needs.detect-and-plan.outputs.skill_count }}
          TRANSLATE_ALL: ${{ needs.detect-and-plan.outputs.translate_all }}
          IS_SHARDED: ${{ needs.detect-and-plan.outputs.is_sharded }}
          SHARD_COUNT: ${{ needs.detect-and-plan.outputs.shard_count }}
        run: |
          echo "# Translation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Mode indicator
          if [ "$TRANSLATE_ALL" = "true" ]; then
            echo "**Mode:** Translate ALL approved skills" >> $GITHUB_STEP_SUMMARY
          elif [ "$IS_SHARDED" = "true" ]; then
            echo "**Mode:** Sharded ($SHARD_COUNT shards)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Simple (single batch)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Requested Skills:** $SKILL_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$RESULT_JSON" ] && echo "$RESULT_JSON" | jq -e '.totalSkills' > /dev/null 2>&1; then
            TRANSLATED=$(echo "$RESULT_JSON" | jq -r '.translated')
            SKIPPED=$(echo "$RESULT_JSON" | jq -r '.skipped')
            ERRORS=$(echo "$RESULT_JSON" | jq -r '.errors')
            DURATION=$(echo "$RESULT_JSON" | jq -r '.durationMs')
            MODEL_USED=$(echo "$RESULT_JSON" | jq -r '.modelUsed // "auto"')
            SHARD_CNT=$(echo "$RESULT_JSON" | jq -r '.shardCount // 1')
            DURATION_MIN=$((DURATION / 60000))
            DURATION_SEC=$(((DURATION % 60000) / 1000))

            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ¤– Model | $MODEL_USED |" >> $GITHUB_STEP_SUMMARY
            [ "$SHARD_CNT" -gt 1 ] && echo "| ðŸ”€ Shards | $SHARD_CNT |" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Translated | $TRANSLATED |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Duration | ${DURATION_MIN}m ${DURATION_SEC}s |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$ERRORS" -gt 0 ]; then
              echo "### âš ï¸ Some translations failed" >> $GITHUB_STEP_SUMMARY
              echo "Check individual shard logs for error details." >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [ "${{ needs.translate.result }}" = "success" ]; then
              echo "âœ… Translation completed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.translate.result }}" = "failure" ]; then
              echo "âŒ Translation failed. Check job logs." >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Translation status: ${{ needs.translate.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.invalidate-cache.result }}" = "success" ]; then
            echo "âœ… Cache invalidated" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.invalidate-cache.result }}" = "skipped" ]; then
            echo "â­ï¸ Cache invalidation skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Cache invalidation: ${{ needs.invalidate-cache.result }}" >> $GITHUB_STEP_SUMMARY
          fi
