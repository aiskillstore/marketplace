# GitHub Action Workflow for Marketplace Repository
# Batch translation mode: single job processes all skills with parallel language translation

name: Auto-Translate Skill Content

on:
  push:
    branches: [main]
    paths:
      - "plugins/**/skill-report.json"
  workflow_dispatch:
    inputs:
      plugin_slugs:
        description: "Specific plugins to translate, comma-separated (e.g., owner-repo1,owner-repo2)"
        required: false
      model:
        description: "Model to use (e.g., gpt-5.2-codex:high, claude-sonnet-4.5). Auto-detects agent."
        type: string
        default: ""
      force:
        description: "Force re-translation of existing translations"
        type: boolean
        default: false
      concurrency:
        description: "Parallel language translations per skill (1-10)"
        type: string
        default: "3"
      cli_version:
        description: "CLI version (default: latest)"
        required: false
        type: string
        default: "latest"

env:
  CLI_VERSION: ${{ inputs.cli_version || 'latest' }}

concurrency:
  group: translate-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      slugs_csv: ${{ steps.detect.outputs.slugs_csv }}
      slugs_json: ${{ steps.detect.outputs.slugs_json }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      skill_count: ${{ steps.detect.outputs.skill_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed plugins
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.plugin_slugs }}" ]; then
            SLUGS_CSV="${{ github.event.inputs.plugin_slugs }}"
            SLUGS_JSON=$(echo "$SLUGS_CSV" | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0))')
            SKILL_COUNT=$(echo "$SLUGS_CSV" | tr ',' '\n' | wc -l | tr -d ' ')
            echo "slugs_csv=$SLUGS_CSV" >> $GITHUB_OUTPUT
            echo "slugs_json=$SLUGS_JSON" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "skill_count=$SKILL_COUNT" >> $GITHUB_OUTPUT
            echo "Manual trigger for: $SLUGS_CSV"
            exit 0
          fi

          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            CHANGED=$(find plugins -name "skill-report.json" -type f 2>/dev/null || true)
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep 'skill-report.json' || true)
          fi

          SLUGS=""
          for file in $CHANGED; do
            PLUGIN=$(echo "$file" | sed -n 's|plugins/\([^/]*/[^/]*\)/skill-report.json|\1|p')
            if [ -n "$PLUGIN" ]; then
              SLUG=$(echo "$PLUGIN" | tr '/' '-')
              [ -n "$SLUGS" ] && SLUGS="$SLUGS,$SLUG" || SLUGS="$SLUG"
            fi
          done

          if [ -z "$SLUGS" ]; then
            echo "slugs_csv=" >> $GITHUB_OUTPUT
            echo "slugs_json=[]" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "skill_count=0" >> $GITHUB_OUTPUT
          else
            SLUGS_JSON=$(echo "$SLUGS" | tr ',' '\n' | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
            SLUGS_CSV=$(echo "$SLUGS" | tr ',' '\n' | sort -u | paste -sd,)
            SKILL_COUNT=$(echo "$SLUGS" | tr ',' '\n' | sort -u | wc -l | tr -d ' ')
            echo "slugs_csv=$SLUGS_CSV" >> $GITHUB_OUTPUT
            echo "slugs_json=$SLUGS_JSON" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "skill_count=$SKILL_COUNT" >> $GITHUB_OUTPUT
          fi

          echo "Detected skills: $SLUGS_CSV (count: $SKILL_COUNT)"

  translate:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: self-hosted
    environment: production
    timeout-minutes: 120
    outputs:
      result_json: ${{ steps.translate.outputs.result_json }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/actions

      - name: Download Skillstore CLI
        uses: ./.github/actions/download-skillstore-cli
        with:
          version: ${{ inputs.cli_version || 'latest' }}
          token: ${{ secrets.PAT_TOKEN }}

      - name: Translate skills (batch mode)
        id: translate
        timeout-minutes: 90
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SKILLSTORE_AGENTS: ${{ secrets.SKILLSTORE_AGENTS }}
          SLUGS_CSV: ${{ needs.detect-changes.outputs.slugs_csv }}
          SKILL_COUNT: ${{ needs.detect-changes.outputs.skill_count }}
          CONCURRENCY: ${{ inputs.concurrency || '3' }}
        run: |
          echo "ðŸš€ Translating $SKILL_COUNT skill(s) with concurrency $CONCURRENCY"
          echo "Skills: $SLUGS_CSV"

          MODEL_FLAG=""
          if [ -n "${{ inputs.model }}" ]; then
            MODEL_FLAG="--model ${{ inputs.model }}"
          fi

          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi

          set +e
          RESULT=$(./skillstore-cli skill translate-content \
            --slugs "$SLUGS_CSV" \
            --concurrency "$CONCURRENCY" \
            --output json \
            $MODEL_FLAG \
            $FORCE_FLAG 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$RESULT" > translation-result.json

          if echo "$RESULT" | jq -e '.totalSkills' > /dev/null 2>&1; then
            TRANSLATED=$(echo "$RESULT" | jq -r '.translated')
            SKIPPED=$(echo "$RESULT" | jq -r '.skipped')
            ERRORS=$(echo "$RESULT" | jq -r '.errors')
            DURATION=$(echo "$RESULT" | jq -r '.durationMs')
            DURATION_SEC=$((DURATION / 1000))

            echo "ðŸ“Š Results: $TRANSLATED translated, $SKIPPED skipped, $ERRORS errors (${DURATION_SEC}s)"

            echo "result_json<<EOF" >> $GITHUB_OUTPUT
            echo "$RESULT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            if [ "$ERRORS" -gt 0 ] && [ "$TRANSLATED" -eq 0 ]; then
              echo "âŒ All translations failed"
              exit 1
            elif [ "$ERRORS" -gt 0 ]; then
              echo "âš ï¸ Some translations failed, but continuing"
            else
              echo "âœ… All translations successful"
            fi
          else
            echo "âŒ Translation failed with unexpected output"
            echo "$RESULT"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: rm -f skillstore-cli translation-result.json

  invalidate-cache:
    needs: [detect-changes, translate]
    if: needs.translate.result == 'success'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/actions

      - name: Invalidate cache for translated skills
        uses: ./.github/actions/invalidate-cache
        with:
          type: skills
          slugs: ${{ needs.detect-changes.outputs.slugs_csv }}
          secret: ${{ secrets.CACHE_INVALIDATE_SECRET }}

  notify:
    needs: [detect-changes, translate, invalidate-cache]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        env:
          RESULT_JSON: ${{ needs.translate.outputs.result_json }}
        run: |
          echo "# Translation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Skills:** ${{ needs.detect-changes.outputs.skill_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$RESULT_JSON" ] && echo "$RESULT_JSON" | jq -e '.totalSkills' > /dev/null 2>&1; then
            TRANSLATED=$(echo "$RESULT_JSON" | jq -r '.translated')
            SKIPPED=$(echo "$RESULT_JSON" | jq -r '.skipped')
            ERRORS=$(echo "$RESULT_JSON" | jq -r '.errors')
            DURATION=$(echo "$RESULT_JSON" | jq -r '.durationMs')
            DURATION_MIN=$((DURATION / 60000))
            DURATION_SEC=$(((DURATION % 60000) / 1000))

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Translated | $TRANSLATED |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Duration | ${DURATION_MIN}m ${DURATION_SEC}s |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$ERRORS" -gt 0 ]; then
              echo "### Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$RESULT_JSON" | jq -r '.skills[] | select(.errors > 0) | .slug + ": " + (.languages[] | select(.status == "error") | .language + " - " + .message)' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [ "${{ needs.translate.result }}" = "success" ]; then
              echo "âœ… Translation completed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.translate.result }}" = "failure" ]; then
              echo "âŒ Translation failed. Check job logs." >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Translation status: ${{ needs.translate.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.invalidate-cache.result }}" = "success" ]; then
            echo "âœ… Cache invalidated" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.invalidate-cache.result }}" = "skipped" ]; then
            echo "â­ï¸ Cache invalidation skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Cache invalidation: ${{ needs.invalidate-cache.result }}" >> $GITHUB_STEP_SUMMARY
          fi
