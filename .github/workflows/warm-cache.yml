name: Warm KV Cache

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'warm = fill missing cache, force = clear all and regenerate'
        required: true
        type: choice
        options:
          - warm
          - force
        default: warm
      type:
        description: 'Content type to warm'
        required: true
        type: choice
        options:
          - skills
          - workflows
          - releases
          - all
        default: skills

concurrency:
  group: warm-cache
  cancel-in-progress: false

env:
  SITE_URL: https://skillstore.io
  LOCALES: 'en zh-hans zh-hant ja ko de fr es pt ru ar'
  CONCURRENCY: 10

jobs:
  warm:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch all slugs from Supabase
        id: fetch
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          CONTENT_TYPE: ${{ inputs.type }}
        run: |
          # Paginated fetch from Supabase REST API (no limit)
          fetch_all_from_supabase() {
            local table=$1
            local column=${2:-slug}
            local offset=0
            local limit=1000
            local all_items=""
            
            while true; do
              response=$(curl -sf "${SUPABASE_URL}/rest/v1/${table}?select=${column}&offset=${offset}&limit=${limit}" \
                -H "apikey: ${SUPABASE_SERVICE_KEY}" \
                -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}")
              
              items=$(echo "$response" | jq -r ".[].${column}" | tr '\n' ' ')
              count=$(echo "$items" | wc -w | tr -d ' ')
              
              if [ "$count" -eq 0 ]; then
                break
              fi
              
              all_items="$all_items $items"
              offset=$((offset + limit))
              echo "  Fetched $count items (offset: $((offset - limit)))" >&2
            done
            
            echo "$all_items" | tr -s ' '
          }
          
          SKILLS_SLUGS=""
          WORKFLOWS_SLUGS=""
          RELEASES_TAGS=""
          
          if [ "$CONTENT_TYPE" = "skills" ] || [ "$CONTENT_TYPE" = "all" ]; then
            echo "Fetching all skills from Supabase..."
            SKILLS_SLUGS=$(fetch_all_from_supabase "skillstore.skills" "slug")
            echo "skills_slugs=$SKILLS_SLUGS" >> $GITHUB_OUTPUT
            SKILLS_COUNT=$(echo $SKILLS_SLUGS | wc -w | tr -d ' ')
            echo "Found $SKILLS_COUNT skills"
          fi
          
          if [ "$CONTENT_TYPE" = "workflows" ] || [ "$CONTENT_TYPE" = "all" ]; then
            echo "Fetching all workflows from Supabase..."
            WORKFLOWS_SLUGS=$(fetch_all_from_supabase "skillstore.workflows" "slug")
            echo "workflows_slugs=$WORKFLOWS_SLUGS" >> $GITHUB_OUTPUT
            WORKFLOWS_COUNT=$(echo $WORKFLOWS_SLUGS | wc -w | tr -d ' ')
            echo "Found $WORKFLOWS_COUNT workflows"
          fi
          
          if [ "$CONTENT_TYPE" = "releases" ] || [ "$CONTENT_TYPE" = "all" ]; then
            echo "Fetching all releases from Supabase..."
            RELEASES_TAGS=$(fetch_all_from_supabase "skillstore.releases" "tag")
            echo "releases_tags=$RELEASES_TAGS" >> $GITHUB_OUTPUT
            RELEASES_COUNT=$(echo $RELEASES_TAGS | wc -w | tr -d ' ')
            echo "Found $RELEASES_COUNT releases"
          fi

      - name: Invalidate all caches (force mode only)
        if: inputs.mode == 'force'
        env:
          CACHE_SECRET: ${{ secrets.CACHE_INVALIDATE_SECRET }}
          SKILLS_SLUGS: ${{ steps.fetch.outputs.skills_slugs }}
          WORKFLOWS_SLUGS: ${{ steps.fetch.outputs.workflows_slugs }}
          RELEASES_TAGS: ${{ steps.fetch.outputs.releases_tags }}
          CONTENT_TYPE: ${{ inputs.type }}
        run: |
          invalidate() {
            local type=$1
            local slugs=$2
            
            if [ -z "$slugs" ]; then
              echo "No $type to invalidate"
              return
            fi
            
            SLUGS_JSON=$(echo $slugs | tr ' ' '\n' | grep -v '^$' | jq -R . | jq -s .)
            SLUG_COUNT=$(echo $slugs | wc -w | tr -d ' ')
            
            echo "Invalidating $SLUG_COUNT $type..."
            curl -sf -X POST "$SITE_URL/api/cache/invalidate" \
              -H "Authorization: Bearer $CACHE_SECRET" \
              -H "Content-Type: application/json" \
              -d "{\"type\": \"$type\", \"slugs\": $SLUGS_JSON}"
            echo ""
            echo "✓ Invalidated $type cache"
          }
          
          if [ "$CONTENT_TYPE" = "skills" ] || [ "$CONTENT_TYPE" = "all" ]; then
            invalidate "skills" "$SKILLS_SLUGS"
          fi
          
          if [ "$CONTENT_TYPE" = "workflows" ] || [ "$CONTENT_TYPE" = "all" ]; then
            invalidate "workflows" "$WORKFLOWS_SLUGS"
          fi
          
          if [ "$CONTENT_TYPE" = "releases" ] || [ "$CONTENT_TYPE" = "all" ]; then
            invalidate "releases" "$RELEASES_TAGS"
          fi

      - name: Warm skills page cache
        if: inputs.type == 'skills' || inputs.type == 'all'
        env:
          SLUGS: ${{ steps.fetch.outputs.skills_slugs }}
        run: |
          if [ -z "$SLUGS" ]; then
            echo "No skills to warm"
            exit 0
          fi
          
          generate_urls() {
            for slug in $SLUGS; do
              [ -z "$slug" ] && continue
              for locale in $LOCALES; do
                if [ "$locale" = "en" ]; then
                  echo "$SITE_URL/skills/$slug"
                else
                  echo "$SITE_URL/$locale/skills/$slug"
                fi
              done
            done
          }
          
          URLS=$(generate_urls)
          URL_COUNT=$(echo "$URLS" | grep -c . || echo 0)
          
          echo "Warming $URL_COUNT skill URLs ($(echo $SLUGS | wc -w | tr -d ' ') skills × 11 locales)..."
          echo ""
          
          SUCCESS=0
          FAILED=0
          
          echo "$URLS" | xargs -P $CONCURRENCY -I {} sh -c '
            STATUS=$(curl -sf -o /dev/null -w "%{http_code}" --max-time 60 "{}" 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "✓ {}"
            else
              echo "✗ {} ($STATUS)" >&2
            fi
          '
          
          echo ""
          echo "Skills page cache warming complete"

      - name: Warm skills ZIP download cache
        if: inputs.type == 'skills' || inputs.type == 'all'
        env:
          SLUGS: ${{ steps.fetch.outputs.skills_slugs }}
        run: |
          if [ -z "$SLUGS" ]; then
            echo "No skills to warm ZIP cache"
            exit 0
          fi
          
          SLUG_COUNT=$(echo $SLUGS | wc -w | tr -d ' ')
          echo "Warming ZIP cache for $SLUG_COUNT skills..."
          echo ""
          
          for slug in $SLUGS; do
            [ -z "$slug" ] && continue
            URL="$SITE_URL/api/skills/$slug/download"
            STATUS=$(curl -sf -o /dev/null -w "%{http_code}" --max-time 120 "$URL" 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "✓ ZIP: $slug"
            else
              echo "✗ ZIP: $slug ($STATUS)" >&2
            fi
          done
          
          echo ""
          echo "Skills ZIP cache warming complete"

      - name: Warm workflows cache
        if: inputs.type == 'workflows' || inputs.type == 'all'
        env:
          SLUGS: ${{ steps.fetch.outputs.workflows_slugs }}
        run: |
          if [ -z "$SLUGS" ]; then
            echo "No workflows to warm"
            exit 0
          fi
          
          generate_urls() {
            for slug in $SLUGS; do
              [ -z "$slug" ] && continue
              for locale in $LOCALES; do
                if [ "$locale" = "en" ]; then
                  echo "$SITE_URL/workflows/$slug"
                else
                  echo "$SITE_URL/$locale/workflows/$slug"
                fi
              done
            done
          }
          
          URLS=$(generate_urls)
          URL_COUNT=$(echo "$URLS" | grep -c . || echo 0)
          
          echo "Warming $URL_COUNT workflow URLs ($(echo $SLUGS | wc -w | tr -d ' ') workflows × 11 locales)..."
          echo ""
          
          echo "$URLS" | xargs -P $CONCURRENCY -I {} sh -c '
            STATUS=$(curl -sf -o /dev/null -w "%{http_code}" --max-time 60 "{}" 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "✓ {}"
            else
              echo "✗ {} ($STATUS)" >&2
            fi
          '
          
          echo ""
          echo "Workflows cache warming complete"

      - name: Warm releases cache
        if: inputs.type == 'releases' || inputs.type == 'all'
        env:
          TAGS: ${{ steps.fetch.outputs.releases_tags }}
        run: |
          if [ -z "$TAGS" ]; then
            echo "No releases to warm"
            exit 0
          fi
          
          generate_urls() {
            for tag in $TAGS; do
              [ -z "$tag" ] && continue
              for locale in $LOCALES; do
                if [ "$locale" = "en" ]; then
                  echo "$SITE_URL/releases/$tag"
                else
                  echo "$SITE_URL/$locale/releases/$tag"
                fi
              done
            done
          }
          
          URLS=$(generate_urls)
          URL_COUNT=$(echo "$URLS" | grep -c . || echo 0)
          
          echo "Warming $URL_COUNT release URLs ($(echo $TAGS | wc -w | tr -d ' ') releases × 11 locales)..."
          echo ""
          
          echo "$URLS" | xargs -P $CONCURRENCY -I {} sh -c '
            STATUS=$(curl -sf -o /dev/null -w "%{http_code}" --max-time 60 "{}" 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "✓ {}"
            else
              echo "✗ {} ($STATUS)" >&2
            fi
          '
          
          echo ""
          echo "Releases cache warming complete"

      - name: Summary
        env:
          MODE: ${{ inputs.mode }}
          CONTENT_TYPE: ${{ inputs.type }}
          SKILLS_SLUGS: ${{ steps.fetch.outputs.skills_slugs }}
          WORKFLOWS_SLUGS: ${{ steps.fetch.outputs.workflows_slugs }}
          RELEASES_TAGS: ${{ steps.fetch.outputs.releases_tags }}
        run: |
          SKILLS_COUNT=$(echo $SKILLS_SLUGS | wc -w | tr -d ' ')
          WORKFLOWS_COUNT=$(echo $WORKFLOWS_SLUGS | wc -w | tr -d ' ')
          RELEASES_COUNT=$(echo $RELEASES_TAGS | wc -w | tr -d ' ')
          LOCALE_COUNT=11
          
          SKILLS_URLS=$((SKILLS_COUNT * LOCALE_COUNT))
          SKILLS_ZIPS=$SKILLS_COUNT
          WORKFLOWS_URLS=$((WORKFLOWS_COUNT * LOCALE_COUNT))
          RELEASES_URLS=$((RELEASES_COUNT * LOCALE_COUNT))
          TOTAL_URLS=$((SKILLS_URLS + SKILLS_ZIPS + WORKFLOWS_URLS + RELEASES_URLS))
          
          echo "## Cache Warming Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mode | \`$MODE\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Content Type | \`$CONTENT_TYPE\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$MODE" = "force" ]; then
            echo "> **Force mode**: All caches were invalidated before warming" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CONTENT_TYPE" = "skills" ] || [ "$CONTENT_TYPE" = "all" ]; then
            echo "| Skills | $SKILLS_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Skill Page URLs | $SKILLS_URLS |" >> $GITHUB_STEP_SUMMARY
            echo "| Skill ZIP Downloads | $SKILLS_COUNT |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$CONTENT_TYPE" = "workflows" ] || [ "$CONTENT_TYPE" = "all" ]; then
            echo "| Workflows | $WORKFLOWS_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Workflow URLs | $WORKFLOWS_URLS |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$CONTENT_TYPE" = "releases" ] || [ "$CONTENT_TYPE" = "all" ]; then
            echo "| Releases | $RELEASES_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Release URLs | $RELEASES_URLS |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| **Total URLs** | **$TOTAL_URLS** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Cache warming completed" >> $GITHUB_STEP_SUMMARY
